<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Master Pro v3.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }

        /* Gradasi Shift */
        .shift-1 { background: linear-gradient(135deg, #FFD97D 0%, #FFB000 100%) !important; color: #000 !important; font-weight: 900 !important; }
        .shift-2 { background: linear-gradient(135deg, #6BF1AB 0%, #00A86B 100%) !important; color: #000 !important; font-weight: 900 !important; }
        .shift-3 { background: linear-gradient(135deg, #8E9EFF 0%, #4755E3 100%) !important; color: #000 !important; font-weight: 900 !important; }
        .shift-off { background: linear-gradient(135deg, #FF9E9E 0%, #D61C1C 100%) !important; color: #000 !important; font-weight: 900 !important; }
        .shift-ct { background: linear-gradient(135deg, #E2E8F0 0%, #94A3B8 100%) !important; color: #000 !important; font-weight: 900 !important; }

        /* Ukuran Tabel Lebih Ringkas */
        .table-custom { border: 2px solid #1e293b !important; border-separate: separate; border-spacing: 0; font-size: 13px; }
        .table-custom select { font-size: 1.25rem !important; padding: 0.75rem 0 !important; }
        
        /* Sticky Column */
        .sticky-no { position: sticky; left: 0; z-index: 40 !important; background-color: #f1f5f9 !important; min-width: 40px; color: #000 !important; }
        .sticky-nama { position: sticky; left: 40px; z-index: 40 !important; background-color: #ffffff !important; min-width: 180px; box-shadow: 4px 0 6px -2px rgba(0,0,0,0.1); color: #000 !important; }
        thead th.sticky-no, thead th.sticky-nama { z-index: 50 !important; background-color: #e2e8f0 !important; color: #000 !important; font-weight: 800; }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#F8FAFC] min-h-screen pb-20">

    <nav class="bg-slate-900 text-white p-6 shadow-2xl mb-8 border-b-4 border-indigo-500">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-500 p-2 rounded-lg rotate-3 italic font-black text-xl">SM</div>
                <h1 class="text-2xl font-extrabold tracking-tighter italic uppercase">Schedule Master <span class="text-indigo-400 font-light text-xs">v3.3</span></h1>
            </div>
            <div class="flex items-center gap-6">
                <div class="bg-white p-1 rounded shadow-md">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Logo_Indomaret.png" alt="Indomaret" class="h-7 w-auto">
                </div>
                <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">Reset Total</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 bg-white rounded-[2rem] shadow-xl p-8 border border-slate-100">
                <h2 id="formTitle" class="text-slate-800 font-extrabold text-xl mb-6 flex items-center gap-3 italic uppercase">
                    <i class="fas fa-user-plus text-indigo-500"></i> Registrasi Staff
                </h2>
                <input type="hidden" id="editIndex" value="-1">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 mb-2 block uppercase">Nama Staff</label>
                        <input type="text" id="inpNama" class="w-full bg-blue-50 border-2 border-blue-200 rounded-2xl px-5 py-4 outline-none font-bold text-blue-900 shadow-inner">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 mb-2 block uppercase">Jabatan</label>
                        <select id="inpJabatan" class="w-full bg-emerald-50 border-2 border-emerald-200 rounded-2xl px-5 py-4 outline-none font-bold text-emerald-900 shadow-inner">
                            <option value="">Pilih Role...</option>
                            <option value="COS">COS (Chief of Store)</option>
                            <option value="SSL">SSL (Store Senior Leader)</option>
                            <option value="SJL">SJL (Store Junior Leader)</option>
                            <option value="SCB">SCB (Store Crew Boy)</option>
                            <option value="SCG">SCG (Store Crew Girl)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 mb-2 block uppercase">Gender</label>
                        <select id="inpGender" class="w-full bg-purple-50 border-2 border-purple-200 rounded-2xl px-5 py-4 outline-none font-bold text-purple-900 shadow-inner">
                            <option value="">Pilih Gender...</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                </div>
                <button id="btnSimpan" onclick="tambahKaryawan()" class="mt-8 w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-black py-5 rounded-2xl shadow-xl uppercase italic">Masukkan Data</button>
            </div>

            <div class="bg-indigo-600 rounded-[2rem] shadow-xl p-8 text-white relative">
                <h2 class="font-black text-xl mb-6 italic uppercase"><i class="fas fa-calendar-check mr-2"></i> Periode</h2>
                <input type="date" id="tglMulai" onchange="generateDates(); autoSave();" class="w-full bg-white/20 border-2 border-white/30 rounded-2xl px-5 py-4 font-bold text-white mb-6 backdrop-blur-md">
            </div>
        </div>

        <div id="containerJadwal" class="hidden fade-in">
            <div id="captureArea" class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h2 class="text-xl font-black text-slate-800 italic uppercase">Jadwal Operasional</h2>
                    <span id="labelPeriode" class="text-xs font-black text-indigo-600 border-2 border-indigo-100 px-4 py-2 rounded-full"></span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full table-custom border-collapse" id="mainTable">
                        <thead>
                            <tr id="headerDays">
                                <th class="p-2 italic text-center sticky-no">NO</th>
                                <th class="p-3 text-left italic sticky-nama">STAFF PROFILE</th>
                                <th class="p-3 text-center min-w-[140px] bg-orange-600 italic text-white">RIWAYAT OFF</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyJadwal"></tbody>
                    </table>
                </div>
            </div>

            <div id="errorContainer" class="hidden mt-8">
                <div class="bg-red-50 border-l-[12px] border-red-600 p-6 rounded-3xl shadow-xl">
                    <h4 class="text-red-700 font-black mb-4 italic uppercase"><i class="fas fa-exclamation-triangle mr-3"></i> Pelanggaran Aturan:</h4>
                    <ul id="errorList" class="text-slate-700 font-bold italic text-sm space-y-1"></ul>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 justify-center mt-12 mb-20">
                <button onclick="koreksiJadwal()" class="bg-slate-900 hover:bg-black text-white px-6 py-4 rounded-2xl font-black shadow-xl uppercase italic">Validasi</button>
                <button onclick="simpanSebagaiGambar()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-2xl font-black shadow-xl uppercase italic">Simpan Gambar (JPG)</button>
                <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-4 rounded-2xl font-black shadow-xl uppercase italic"><i class="fas fa-file-excel mr-2"></i>Download XLSX</button>
            </div>
        </div>
    </div>

    <script>
        const hariIndo = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu", "Minggu"];
        let dataKaryawan = [];

        window.onload = () => {
            const savedData = localStorage.getItem('jadwal_karyawan');
            const savedDate = localStorage.getItem('jadwal_tanggal');
            if (savedData) {
                dataKaryawan = JSON.parse(savedData);
                document.getElementById('tglMulai').value = savedDate || '';
                if(dataKaryawan.length > 0) {
                    document.getElementById('containerJadwal').classList.remove('hidden');
                    generateDates();
                    renderTabel();
                }
            }
        };

        function generateDates() {
            const startDateInput = document.getElementById('tglMulai').value;
            const headerRow = document.getElementById('headerDays');
            if (!startDateInput) return;
            while (headerRow.cells.length > 3) headerRow.deleteCell(3);
            const start = new Date(startDateInput);
            document.getElementById('labelPeriode').innerText = `PERIODE: ${start.toLocaleDateString('id-ID', {day:'numeric', month:'long'})}`;
            for (let i = 0; i < 7; i++) {
                const current = new Date(start);
                current.setDate(start.getDate() + i);
                const th = document.createElement('th');
                th.className = "p-2 text-center min-w-[90px] border-r border-white/10";
                th.innerHTML = `<div class="text-[9px] opacity-60 uppercase">${hariIndo[i]}</div><div class="text-sm font-black">${current.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit' })}</div>`;
                headerRow.appendChild(th);
            }
        }

        function renderTabel() {
            const tbody = document.getElementById('tbodyJadwal');
            tbody.innerHTML = '';
            dataKaryawan.forEach((k, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 text-center font-black sticky-no">${idx + 1}</td>
                    <td class="p-3 border-r border-slate-50 sticky-nama">
                        <div class="font-black text-slate-800 text-base uppercase italic whitespace-nowrap">${k.nama}</div>
                        <div class="flex gap-1 mt-1">
                            <span class="px-2 py-0.5 bg-slate-800 text-white rounded text-[8px] font-black italic">${k.jabatan}</span>
                            <span class="px-2 py-0.5 bg-indigo-500 text-white rounded text-[8px] font-black italic">${k.gender}</span>
                            <button onclick="editKaryawan(${idx})" class="ml-1 text-indigo-600 text-[10px]"><i class="fas fa-edit"></i></button>
                        </div>
                    </td>
                    <td class="p-3 bg-orange-50/10 text-center">
                        <input type="date" onchange="updateRiwayat(${idx}, this.value)" class="text-[9px] w-full mb-1 p-1 border rounded font-bold">
                        <div class="flex flex-wrap justify-center gap-1">
                            ${k.riwayatLibur.map(day => `<span class="bg-orange-500 text-white text-[8px] px-2 py-0.5 rounded-full font-black italic">${day}</span>`).join('')}
                        </div>
                    </td>
                    ${k.shift.map((s, i) => `
                        <td class="p-1.5">
                            <select onchange="updateShift(${idx}, ${i}, this.value)" class="w-full rounded-xl text-center font-black shadow-sm outline-none ${getShiftClass(s)}">
                                <option value="1" ${s==='1'?'selected':''}>1</option>
                                <option value="2" ${s==='2'?'selected':''}>2</option>
                                <option value="3" ${s==='3'?'selected':''}>3</option>
                                <option value="OFF" ${s==='OFF'?'selected':''}>OFF</option>
                                <option value="CT" ${s==='CT'?'selected':''}>CT</option>
                            </select>
                        </td>
                    `).join('')}
                `;
                tbody.appendChild(tr);
            });
        }

        function updateShift(idx, dayIdx, val) {
            dataKaryawan[idx].shift[dayIdx] = val;
            autoSave();
            renderTabel();
        }

        function getShiftClass(val) {
            if(val == '1') return 'shift-1';
            if(val == '2') return 'shift-2';
            if(val == '3') return 'shift-3';
            if(val == 'OFF') return 'shift-off';
            if(val == 'CT') return 'shift-ct';
            return '';
        }

        function koreksiJadwal() {
            const errors = [];
            const pimpinan = ["COS", "SSL", "SJL"];
            for (let d = 0; d < 7; d++) {
                const shiftTim = { "1": [], "2": [], "3": [], "OFF": [], "CT": [] };
                dataKaryawan.forEach(k => shiftTim[k.shift[d]].push(k));
                ["1", "2", "3"].forEach(s => {
                    const tim = shiftTim[s];
                    if (tim.length > 0) {
                        if (!tim.some(k => pimpinan.includes(k.jabatan))) errors.push(`${hariIndo[d]}: Shift ${s} tanpa Pimpinan.`);
                        if (!tim.some(k => k.gender === "L")) errors.push(`${hariIndo[d]}: Shift ${s} tanpa laki-laki.`);
                    }
                });
                const boss = dataKaryawan.filter(k => k.jabatan === "COS" || k.jabatan === "SSL");
                if (boss.length >= 2 && boss[0].shift[d] === boss[1].shift[d]) {
                    errors.push(`${hariIndo[d]}: COS & SSL tidak boleh bareng.`);
                }
            }
            dataKaryawan.forEach(k => {
                const offs = k.shift.filter(s => s === "OFF").length;
                if (offs !== 1) errors.push(`${k.nama}: Harus libur 1x (saat ini ${offs}x).`);
                for (let d = 0; d < 6; d++) if (k.shift[d] === "3" && k.shift[d+1] === "1") errors.push(`${k.nama}: Pelanggaran Long Shift.`);
                const hOff = hariIndo[k.shift.indexOf("OFF")];
                if (hOff && k.riwayatLibur.includes(hOff)) errors.push(`${k.nama}: Libur ${hOff} sudah pernah diambil.`);
            });
            const errDiv = document.getElementById('errorContainer');
            const errList = document.getElementById('errorList');
            errList.innerHTML = '';
            if(errors.length > 0) {
                errDiv.classList.remove('hidden');
                [...new Set(errors)].forEach(e => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-times-circle mr-2 text-red-600"></i>${e}`;
                    errList.appendChild(li);
                });
                errDiv.scrollIntoView({ behavior: 'smooth' });
            } else {
                errDiv.classList.add('hidden');
                alert("âœ… JADWAL VALID!");
            }
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const wsData = [["NO", "NAMA", "JABATAN", ...hariIndo]];
            dataKaryawan.forEach((k, idx) => {
                wsData.push([idx + 1, k.nama, k.jabatan, ...k.shift]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Jadwal");
            XLSX.writeFile(wb, `Jadwal-TSM-${document.getElementById('tglMulai').value}.xlsx`);
        }

        function simpanSebagaiGambar() {
            const element = document.getElementById('captureArea');
            // Menghitung lebar total elemen (termasuk yang tidak terlihat karena overflow)
            const width = element.scrollWidth;
            const height = element.scrollHeight;
            
            html2canvas(element, {
                width: width,
                height: height,
                scale: 2,
                scrollX: 0,
                scrollY: -window.scrollY,
                useCORS: true,
                windowWidth: width,
                windowHeight: height
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Jadwal-TSM.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            });
        }

        function autoSave() {
            localStorage.setItem('jadwal_karyawan', JSON.stringify(dataKaryawan));
            localStorage.setItem('jadwal_tanggal', document.getElementById('tglMulai').value);
        }

        function tambahKaryawan() {
            const n = document.getElementById('inpNama').value, j = document.getElementById('inpJabatan').value, g = document.getElementById('inpGender').value;
            const editIdx = document.getElementById('editIndex').value;
            if(!n || !j || !g) return alert("Lengkapi data!");
            if(editIdx === "-1") {
                dataKaryawan.push({ id: Date.now(), nama: n, jabatan: j, gender: g, riwayatLibur: [], shift: Array(7).fill('1') });
            } else {
                dataKaryawan[editIdx].nama = n; dataKaryawan[editIdx].jabatan = j; dataKaryawan[editIdx].gender = g;
                resetFormStaff();
            }
            autoSave(); renderTabel(); document.getElementById('containerJadwal').classList.remove('hidden');
        }

        function editKaryawan(idx) {
            const k = dataKaryawan[idx];
            document.getElementById('inpNama').value = k.nama;
            document.getElementById('inpJabatan').value = k.jabatan;
            document.getElementById('inpGender').value = k.gender;
            document.getElementById('editIndex').value = idx;
            document.getElementById('formTitle').innerText = `Edit Staff: ${k.nama}`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFormStaff() {
            document.getElementById('inpNama').value = ''; document.getElementById('editIndex').value = "-1";
            document.getElementById('formTitle').innerText = "Registrasi Staff";
        }

        function updateRiwayat(idx, date) {
            if(!date) return;
            const d = new Date(date), h = hariIndo[d.getDay() === 0 ? 6 : d.getDay() - 1];
            if(!dataKaryawan[idx].riwayatLibur.includes(h)) {
                dataKaryawan[idx].riwayatLibur.push(h);
                if(dataKaryawan[idx].riwayatLibur.length > 3) dataKaryawan[idx].riwayatLibur.shift();
                autoSave(); renderTabel();
            }
        }

        function clearAllData() { if(confirm("Reset total?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
