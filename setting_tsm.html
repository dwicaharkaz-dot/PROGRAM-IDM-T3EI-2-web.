<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Master Pro v3.3 - Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1aMjPJDQPmZMTP5LDouI_j47kKEJmSWk",
            authDomain: "barcode-qscv.firebaseapp.com",
            projectId: "barcode-qscv",
            databaseURL: "https://barcode-qscv-default-rtdb.asia-southeast1.firebasedatabase.app/",
            storageBucket: "barcode-qscv.firebasestorage.app",
            messagingSenderId: "204134538515",
            appId: "1:204134538515:web:394a3880ced41726950ee6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbPush = push;
        window.dbGet = get;
        window.dbRemove = remove;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .shift-1 { background: linear-gradient(135deg, #FFD97D 0%, #FFB000 100%) !important; color: #000 !important; font-weight: 900 !important; }
        .shift-2 { background: linear-gradient(135deg, #6BF1AB 0%, #00A86B 100%) !important; color: #000 !important; font-weight: 900 !important; }
        .shift-3 { background: linear-gradient(135deg, #8E9EFF 0%, #4755E3 100%) !important; color: #000 !important; font-weight: 900 !important; }
        .shift-off { background: linear-gradient(135deg, #FF9E9E 0%, #D61C1C 100%) !important; color: #000 !important; font-weight: 900 !important; }
        .shift-ct { background: linear-gradient(135deg, #E2E8F0 0%, #94A3B8 100%) !important; color: #000 !important; font-weight: 900 !important; }
        .table-custom { border: 2px solid #1e293b !important; border-separate: separate; border-spacing: 0; font-size: 13px; }
        .table-custom select { font-size: 1.25rem !important; padding: 0.75rem 0 !important; }
        .sticky-no { position: sticky; left: 0; z-index: 40 !important; background-color: #f1f5f9 !important; min-width: 40px; color: #000 !important; }
        .sticky-nama { position: sticky; left: 40px; z-index: 40 !important; background-color: #ffffff !important; min-width: 180px; box-shadow: 4px 0 6px -2px rgba(0,0,0,0.1); color: #000 !important; }
        thead th.sticky-no, thead th.sticky-nama { z-index: 50 !important; background-color: #e2e8f0 !important; color: #000 !important; font-weight: 800; }
        #modalHistory { display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="bg-[#F8FAFC] min-h-screen pb-20">

    <nav class="bg-slate-900 text-white p-6 shadow-2xl mb-8 border-b-4 border-indigo-500">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-500 p-2 rounded-lg rotate-3 italic font-black text-xl">TSM</div>
                <h1 class="text-2xl font-extrabold tracking-tighter italic uppercase">TSM_MOBILE <span class="text-indigo-400 font-light text-xs">v2.2</span></h1>
            </div>
            <div class="bg-white p-1 rounded shadow-md">
                <img src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Logo_Indomaret.png" alt="Indomaret" class="h-7 w-auto">
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 bg-white rounded-[2rem] shadow-xl p-8 border border-slate-100">
                <h2 id="formTitle" class="text-slate-800 font-extrabold text-xl mb-6 flex items-center gap-3 italic uppercase">
                    <i class="fas fa-user-plus text-indigo-500"></i> Registrasi personil
                </h2>
                <input type="hidden" id="editIndex" value="-1">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 mb-2 block uppercase">Nama personil</label>
                        <input type="text" id="inpNama" class="w-full bg-blue-50 border-2 border-blue-200 rounded-2xl px-5 py-4 outline-none font-bold text-blue-900 shadow-inner">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 mb-2 block uppercase">Jabatan</label>
                        <select id="inpJabatan" class="w-full bg-emerald-50 border-2 border-emerald-200 rounded-2xl px-5 py-4 outline-none font-bold text-emerald-900 shadow-inner">
                            <option value="">Pilih jabatan...</option>
                            <option value="COS">COS (Chief of Store)</option>
                            <option value="SSL">SSL (Store Senior Leader)</option>
                            <option value="SJL">SJL (Store Junior Leader)</option>
                            <option value="SCB">SCB (Store Crew Boy)</option>
                            <option value="SCG">SCG (Store Crew Girl)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 mb-2 block uppercase">Gender</label>
                        <select id="inpGender" class="w-full bg-purple-50 border-2 border-purple-200 rounded-2xl px-5 py-4 outline-none font-bold text-purple-900 shadow-inner">
                            <option value="">Pilih Gender...</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                </div>
                <button id="btnSimpan" onclick="tambahKaryawan()" class="mt-8 w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-black py-5 rounded-2xl shadow-xl uppercase italic">Masukkan Data</button>
            </div>

            <div class="bg-indigo-600 rounded-[2rem] shadow-xl p-8 text-white relative">
                <h2 class="font-black text-xl mb-6 italic uppercase"><i class="fas fa-calendar-check mr-2"></i> Periode</h2>
                <input type="date" id="tglMulai" onchange="generateDates(); autoSave();" class="w-full bg-white/20 border-2 border-white/30 rounded-2xl px-5 py-4 font-bold text-white mb-6 backdrop-blur-md">
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="showHistory()" class="bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-black text-[10px] uppercase shadow-lg"><i class="fas fa-history mr-1"></i> History</button>
                    <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-black text-[10px] uppercase shadow-lg">Reset Total</button>
                </div>
                <button onclick="resetOnlyShift()" class="w-full bg-white/10 hover:bg-white/20 border border-white/30 py-3 rounded-xl text-xs font-bold uppercase tracking-widest transition-all">Reset Semua Shift</button>
            </div>
        </div>

        <div id="containerJadwal" class="hidden">
            <div id="captureArea" class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-300">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h2 class="text-xl font-black text-slate-800 italic uppercase">Jadwal Operasional toko</h2>
                    <span id="labelPeriode" class="text-xs font-black text-indigo-600 border-2 border-indigo-100 px-4 py-2 rounded-full"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full table-custom border-collapse" id="mainTable">
                        <thead>
                            <tr id="headerDays">
                                <th class="p-2 italic text-center sticky-no">NO</th>
                                <th class="p-3 text-left italic sticky-nama">NAMA PERSONIL</th>
                                <th class="p-3 text-center min-w-[140px] bg-orange-600 italic text-white">RIWAYAT OFF</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyJadwal"></tbody>
                    </table>
                </div>
            </div>

            <div id="errorContainer" class="hidden mt-8">
                <div class="bg-red-50 border-l-[12px] border-red-600 p-6 rounded-3xl shadow-xl">
                    <h4 class="text-red-700 font-black mb-4 italic uppercase"><i class="fas fa-exclamation-triangle mr-3"></i> Pelanggaran Aturan:</h4>
                    <ul id="errorList" class="text-slate-700 font-bold italic text-sm space-y-1"></ul>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 justify-center mt-12 mb-20">
                <button onclick="koreksiJadwal()" class="bg-slate-900 hover:bg-black text-white px-6 py-4 rounded-2xl font-black shadow-xl uppercase italic">Validasi</button>
                <button onclick="saveToDatabase()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-4 rounded-2xl font-black shadow-xl uppercase italic"><i class="fas fa-cloud-upload-alt mr-2"></i>Simpan ke DB</button>
                <button onclick="simpanSebagaiGambar()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-2xl font-black shadow-xl uppercase italic">Gambar (JPG)</button>
                <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-4 rounded-2xl font-black shadow-xl uppercase italic"><i class="fas fa-file-excel mr-2"></i>Download XLSX</button>
            </div>
        </div>
    </div>

    <div id="modalHistory">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
                <h3 class="font-black italic uppercase">History Jadwal Tersimpan</h3>
                <button onclick="closeHistory()" class="text-2xl">&times;</button>
            </div>
            <div id="historyList" class="p-6 overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <script>
        const hariIndo = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu", "Minggu"];
        let dataKaryawan = [];

        // Load data hanya dari Cloud Firebase saat buka web
        window.onload = async () => {
            const checkFirebase = setInterval(async () => {
                if(window.db) {
                    clearInterval(checkFirebase);
                    try {
                        const snapshot = await window.dbGet(window.dbRef(window.db, 'current_session'));
                        if (snapshot.exists()) {
                            const cloudData = snapshot.val();
                            dataKaryawan = cloudData.data || [];
                            if (cloudData.tanggal) document.getElementById('tglMulai').value = cloudData.tanggal;
                            if(dataKaryawan.length > 0) {
                                document.getElementById('containerJadwal').classList.remove('hidden');
                                generateDates();
                                renderTabel();
                            }
                        }
                    } catch (e) { console.error("Cloud Load Error:", e); }
                }
            }, 500);
        };

        // AUTO SAVE SAAT CLOSE/REFRESH
        window.addEventListener('beforeunload', () => { if(dataKaryawan.length > 0) autoSave(); });
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && dataKaryawan.length > 0) autoSave();
        });

        function generateDates() {
            const startDateInput = document.getElementById('tglMulai').value;
            const headerRow = document.getElementById('headerDays');
            if (!startDateInput) return;
            while (headerRow.cells.length > 3) headerRow.deleteCell(3);
            const start = new Date(startDateInput);
            document.getElementById('labelPeriode').innerText = `PERIODE: ${start.toLocaleDateString('id-ID', {day:'numeric', month:'long'})}`;
            for (let i = 0; i < 7; i++) {
                const current = new Date(start);
                current.setDate(start.getDate() + i);
                const th = document.createElement('th');
                th.className = "p-2 text-center min-w-[90px] border-r border-white/10";
                th.innerHTML = `<div class="text-[9px] opacity-60 uppercase">${hariIndo[i]}</div><div class="text-sm font-black">${current.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit' })}</div>`;
                headerRow.appendChild(th);
            }
        }

        function renderTabel() {
            const tbody = document.getElementById('tbodyJadwal');
            if (!tbody) return;
            tbody.innerHTML = '';
            dataKaryawan.forEach((k, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 text-center font-black sticky-no">${idx + 1}</td>
                    <td class="p-3 border-r border-slate-50 sticky-nama">
                        <div class="font-black text-slate-800 text-base uppercase italic whitespace-nowrap">${k.nama}</div>
                        <div class="flex gap-1 mt-1">
                            <span class="px-2 py-0.5 bg-slate-800 text-white rounded text-[8px] font-black italic">${k.jabatan}</span>
                            <span class="px-2 py-0.5 bg-indigo-500 text-white rounded text-[8px] font-black italic">${k.gender}</span>
                            <button onclick="editKaryawan(${idx})" class="ml-1 text-indigo-600 text-[10px]"><i class="fas fa-edit"></i></button>
                            <button onclick="hapusKaryawan(${idx})" class="text-red-500 text-[10px]"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                    <td class="p-3 bg-orange-50/10 text-center">
                        <input type="date" onchange="updateRiwayat(${idx}, this.value)" class="text-[9px] w-full mb-1 p-1 border rounded font-bold">
                        <div class="flex flex-wrap justify-center gap-1">
                            ${k.riwayatLibur ? k.riwayatLibur.map(day => `<span class="bg-orange-500 text-white text-[8px] px-2 py-0.5 rounded-full font-black italic">${day}</span>`).join('') : ''}
                        </div>
                    </td>
                    ${k.shift.map((s, i) => `
                        <td class="p-1.5">
                            <select onchange="updateShift(${idx}, ${i}, this.value)" class="w-full rounded-xl text-center font-black shadow-sm outline-none ${getShiftClass(s)}">
                                <option value="1" ${s==='1'?'selected':''}>1</option>
                                <option value="2" ${s==='2'?'selected':''}>2</option>
                                <option value="3" ${s==='3'?'selected':''}>3</option>
                                <option value="OFF" ${s==='OFF'?'selected':''}>OFF</option>
                                <option value="CT" ${s==='CT'?'selected':''}>CT</option>
                            </select>
                        </td>
                    `).join('')}
                `;
                tbody.appendChild(tr);
            });
        }

        function getShiftClass(val) {
            if(val == '1') return 'shift-1';
            if(val == '2') return 'shift-2';
            if(val == '3') return 'shift-3';
            if(val == 'OFF') return 'shift-off';
            if(val == 'CT') return 'shift-ct';
            return '';
        }

        function tambahKaryawan() {
            const n = document.getElementById('inpNama').value, j = document.getElementById('inpJabatan').value, g = document.getElementById('inpGender').value;
            const editIdx = document.getElementById('editIndex').value;
            if(!n || !j || !g) return alert("Lengkapi data!");
            if(editIdx === "-1") {
                dataKaryawan.push({ id: Date.now(), nama: n, jabatan: j, gender: g, riwayatLibur: [], shift: Array(7).fill('1') });
            } else {
                dataKaryawan[editIdx].nama = n; dataKaryawan[editIdx].jabatan = j; dataKaryawan[editIdx].gender = g;
                resetFormStaff();
            }
            document.getElementById('containerJadwal').classList.remove('hidden');
            generateDates();
            renderTabel();
            autoSave();
            document.getElementById('inpNama').value = '';
        }

        function hapusKaryawan(idx) {
            if(confirm("Hapus staff ini?")) {
                dataKaryawan.splice(idx, 1);
                renderTabel(); autoSave();
            }
        }

        function editKaryawan(idx) {
            const k = dataKaryawan[idx];
            document.getElementById('inpNama').value = k.nama;
            document.getElementById('inpJabatan').value = k.jabatan;
            document.getElementById('inpGender').value = k.gender;
            document.getElementById('editIndex').value = idx;
            document.getElementById('formTitle').innerText = `Edit Staff: ${k.nama}`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFormStaff() {
            document.getElementById('inpNama').value = ''; 
            document.getElementById('editIndex').value = "-1";
            document.getElementById('formTitle').innerText = "Registrasi Staff";
        }

        function updateShift(idx, dayIdx, val) {
            dataKaryawan[idx].shift[dayIdx] = val;
            renderTabel();
            autoSave();
        }

        function resetOnlyShift() {
            if(confirm("Kembalikan semua shift ke default (Shift 1)?")) {
                dataKaryawan.forEach(k => k.shift = Array(7).fill('1'));
                renderTabel();
                autoSave();
            }
        }

        // Simpan ke Cloud (current_session)
        async function autoSave() {
            const tgl = document.getElementById('tglMulai').value;
            if(window.db && dataKaryawan.length > 0) {
                try {
                    await window.dbSet(window.dbRef(window.db, 'current_session'), {
                        last_updated: new Date().toISOString(),
                        tanggal: tgl,
                        data: dataKaryawan
                    });
                } catch (e) { console.error("Firebase Error:", e); }
            }
        }

        async function saveToDatabase() {
            const tgl = document.getElementById('tglMulai').value;
            if(!tgl) return alert("Pilih tanggal periode dulu!");
            try {
                const newSaveRef = window.dbPush(window.dbRef(window.db, 'history'));
                await window.dbSet(newSaveRef, {
                    save_at: new Date().toLocaleString('id-ID'),
                    tanggal: tgl,
                    data: dataKaryawan
                });
                alert("✅ Jadwal berhasil disimpan ke database!");
            } catch (e) { alert("Gagal menyimpan: " + e.message); }
        }

        async function showHistory() {
            const modal = document.getElementById('modalHistory');
            const list = document.getElementById('historyList');
            modal.style.display = 'flex';
            list.innerHTML = '<p class="text-center italic text-slate-400">Mengambil data...</p>';
            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, 'history'));
                list.innerHTML = '';
                if(snapshot.exists()) {
                    const data = snapshot.val();
                    Object.keys(data).reverse().forEach(key => {
                        const item = data[key];
                        const div = document.createElement('div');
                        div.className = "flex justify-between items-center p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl mb-2";
                        div.innerHTML = `
                            <div>
                                <div class="font-black uppercase text-sm">Periode: ${item.tanggal}</div>
                                <div class="text-[10px] text-slate-500 uppercase">Simpan: ${item.save_at}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="loadHistoryItem('${key}')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black italic">MUAT</button>
                                <button onclick="deleteHistoryItem('${key}')" class="bg-red-100 text-red-600 px-3 py-2 rounded-xl text-[10px] font-black italic hover:bg-red-600 hover:text-white transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>`;
                        list.appendChild(div);
                    });
                } else { list.innerHTML = '<p class="text-center italic text-slate-400">Belum ada history.</p>'; }
            } catch (e) { list.innerHTML = 'Error: ' + e.message; }
        }

        window.loadHistoryItem = async (key) => {
            if(confirm("Muat jadwal ini? Data saat ini akan tertimpa.")) {
                const snapshot = await window.dbGet(window.dbRef(window.db, `history/${key}`));
                if(snapshot.exists()) {
                    const item = snapshot.val();
                    dataKaryawan = item.data;
                    document.getElementById('tglMulai').value = item.tanggal;
                    document.getElementById('containerJadwal').classList.remove('hidden');
                    generateDates(); renderTabel(); closeHistory(); autoSave();
                }
            }
        }

        window.deleteHistoryItem = async (key) => {
            if(confirm("Hapus history ini secara permanen dari database?")) {
                try {
                    await window.dbRemove(window.dbRef(window.db, `history/${key}`));
                    alert("History berhasil dihapus!");
                    showHistory();
                } catch (e) { alert("Gagal menghapus: " + e.message); }
            }
        }

        function closeHistory() { document.getElementById('modalHistory').style.display = 'none'; }
        
        function updateRiwayat(idx, date) {
            if(!date) return;
            const d = new Date(date);
            const namaHari = hariIndo[d.getDay() === 0 ? 6 : d.getDay() - 1];
            if(!dataKaryawan[idx].riwayatLibur) dataKaryawan[idx].riwayatLibur = [];
            
            if(!dataKaryawan[idx].riwayatLibur.includes(namaHari)) {
                dataKaryawan[idx].riwayatLibur.push(namaHari);
                if(dataKaryawan[idx].riwayatLibur.length > 3) dataKaryawan[idx].riwayatLibur.shift();
                renderTabel(); 
                autoSave(); 
            }
        }

        async function clearAllData() { 
            if(confirm("Reset total data di Cloud?")) { 
                try {
                    await window.dbRemove(window.dbRef(window.db, 'current_session'));
                    location.reload(); 
                } catch (e) { alert("Gagal: " + e.message); }
            } 
        }

        function koreksiJadwal() {
            const errors = [];
            const pimpinanRole = ["COS", "SSL", "SJL"];
            for (let d = 0; d < 7; d++) {
                const shiftTim = { "1": [], "2": [], "3": [], "OFF": [], "CT": [] };
                dataKaryawan.forEach(k => { if (k.shift[d]) shiftTim[k.shift[d]].push(k); });
                ["1", "2", "3"].forEach(s => {
                    const tim = shiftTim[s];
                    if (tim.length > 0) {
                        if (!tim.some(k => pimpinanRole.includes(k.jabatan))) errors.push(`${hariIndo[d]}: Shift ${s} wajib ada pimpinan.`);
                        if (!tim.some(k => k.gender === "L")) errors.push(`${hariIndo[d]}: Shift ${s} wajib ada laki-laki.`);
                    }
                });
                const stafCos = dataKaryawan.find(k => k.jabatan === "COS");
                const stafSsl = dataKaryawan.find(k => k.jabatan === "SSL");
                if (stafCos && stafSsl && stafCos.shift[d] === stafSsl.shift[d]) {
                    errors.push(`${hariIndo[d]}: COS & SSL tidak boleh bersamaan.`);
                }
            }
            dataKaryawan.forEach(k => {
                const jumlahOff = k.shift.filter(s => s === "OFF").length;
                if (jumlahOff !== 1) errors.push(`${k.nama}: Wajib 1x OFF.`);
                for (let d = 0; d < 6; d++) if (k.shift[d] === "3" && k.shift[d+1] === "1") errors.push(`${k.nama}: Long Shift.`);
                
                const indexOff = k.shift.indexOf("OFF");
                if (indexOff !== -1) {
                    const hariAkanOff = hariIndo[indexOff];
                    if (k.riwayatLibur && k.riwayatLibur.includes(hariAkanOff)) {
                        errors.push(`${k.nama}: Pelanggaran! Hari ${hariAkanOff} sudah diambil di riwayat minggu lalu.`);
                    }
                }
            });
            const errDiv = document.getElementById('errorContainer');
            const errList = document.getElementById('errorList');
            errList.innerHTML = '';
            if (errors.length > 0) {
                errDiv.classList.remove('hidden');
                [...new Set(errors)].forEach(e => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-times-circle text-red-600"></i> ${e}`;
                    errList.appendChild(li);
                });
            } else { errDiv.classList.add('hidden'); alert("✅ JADWAL VALID!"); }
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const wsData = [["NO", "NAMA", "JABATAN", ...hariIndo]];
            dataKaryawan.forEach((k, idx) => wsData.push([idx + 1, k.nama, k.jabatan, ...k.shift]));
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Jadwal");
            XLSX.writeFile(wb, `Jadwal-TSM.xlsx`);
        }

        function simpanSebagaiGambar() {
            const element = document.getElementById('captureArea');
            html2canvas(element, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Jadwal-TSM.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            });
        }
    </script>
</body>
</html>
