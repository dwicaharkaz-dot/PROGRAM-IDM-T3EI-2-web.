<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BARCODE ESS T3EI</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #007bff; 
            color: white;
            padding: 10px 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        header h1 {
            margin: 0;
            font-size: 1.8em; 
            color: white;
            font-family: 'Oswald', sans-serif; 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            flex-grow: 1; 
            text-align: left; 
            padding-left: 0; 
            white-space: nowrap; 
        }
        .header-separator {
            border: 0;
            height: 3px;
            background-image: linear-gradient(to right, #007bff, #17a2b8, #007bff); 
            margin: 0 0 20px 0; 
        }
        .logo-indomaret {
            height: 35px; 
            margin-right: 5px; 
            background-color: white; 
            padding: 3px 8px; 
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        main {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto; 
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        h2, h3 {
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .employee-item {
            display: block; 
            padding: 12px 20px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
        }
        .employee-item:hover {
            background-color: #e9ecef;
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #add-employee-form, #edit-employee-form {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 10px;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }
        button.copy-btn {
            background-color: #28a745;
            padding: 5px 10px;
            font-size: 0.9em;
            margin-top: 5px;
        }
        button.copy-btn:hover {
            background-color: #1e7e34;
        }
        button:hover {
            background-color: #0056b3;
        }
        #delete-employee-btn {
            background-color: #dc3545;
        }
        #delete-employee-btn:hover {
            background-color: #bd2130;
        }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #barcode-display {
            text-align: center;
            padding: 15px;
            border: 1px dashed #007bff;
            margin-bottom: 15px;
        }
        .barcode-section {
            margin-bottom: 20px;
        }
        .barcode-note {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        #qrcode-nik, #qrcode-password {
            display: inline-block;
            padding: 10px;
            border: 1px solid #ccc;
            background: white;
            margin-bottom: 10px;
        }
        /* Style untuk tombol kembali ke Stock Opname */
        #back-to-so-btn {
            background-color: #f1c40f; 
            color: #333;
            margin-bottom: 20px;
        }
        #back-to-so-btn:hover {
            background-color: #f39c12; 
        }
    </style>
</head>
<body>

    <header>
        <h1>BARCODE ESS T3EI</h1>
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/14/Logo_Indomaret.svg/1200px-Logo_Indomaret.svg.png" alt="Logo Indomaret" class="logo-indomaret">
    </header>
    
    <hr class="header-separator">

    <main>
        <button id="back-to-so-btn" onclick="window.location.href='index.html'">
            ‚Üê Kembali ke Stock Opname
        </button>
        
        <section id="employee-list-section">
            <h2>Daftar Karyawan üßë‚Äçüíº</h2>
            <div id="employee-list-container">
                <p>Memuat data karyawan dari cloud...</p>
                </div>
        </section>

        <hr>

        <section id="add-employee-section">
            <button id="show-add-form-btn">Tambah Daftar Karyawan ‚ûï</button>
            <div id="add-employee-form" style="display:none;">
                <h3>Formulir Tambah Karyawan</h3>
                <form id="new-employee-form">
                    <label for="new-nama">Nama:</label>
                    <input type="text" id="new-nama" required><br>

                    <label for="new-nik">NIK:</label>
                    <input type="text" id="new-nik" required><br>

                    <label for="new-password">Password:</label>
                    <input type="password" id="new-password" required><br>

                    <button type="submit">Simpan Karyawan Baru</button>
                </form>
            </div>
        </section>

        <div id="modal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3 id="modal-title">Detail Barcode & Edit</h3>

                <div id="barcode-display">
                    
                    <div class="barcode-section">
                        <h4>Barcode NIK:</h4>
                        <div id="qrcode-nik"></div>
                        <p class="barcode-note">Data NIK: <strong id="data-nik"></strong></p>
                        <button class="copy-btn" onclick="copyToClipboard('data-nik')">Salin NIK</button>
                    </div>

                    <div class="barcode-section">
                        <h4>Barcode Password:</h4>
                        <div id="qrcode-password"></div>
                        <p class="barcode-note">Data Password: <strong id="data-password"></strong></p>
                        <button class="copy-btn" onclick="copyToClipboard('data-password')">Salin Password</button>
                    </div>
                </div>

                <hr>

                <h4>Edit Data Karyawan</h4>
                <form id="edit-employee-form">
                    <input type="hidden" id="edit-index">
                    <label for="edit-nama">Nama:</label>
                    <input type="text" id="edit-nama" required><br>

                    <label for="edit-nik">NIK:</label>
                    <input type="text" id="edit-nik" required><br>

                    <label for="edit-password">Password:</label>
                    <input type="text" id="edit-password" required><br>

                    <button type="submit">Simpan Perubahan</button>
                    <button type="button" id="delete-employee-btn">Hapus Karyawan</button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // ===================================================================================
        // ‚òÅÔ∏è FIREBASE CLOUD CONFIGURATION & INIT ‚òÅÔ∏è (Sama dengan Stock Opname)
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDlaMjPJDQPQMZMTPSLDOuI_j47kKJEJmSWK", 
            authDomain: "barcode-qscv.firebaseapp.com",
            databaseURL: "https://barcode-qscv-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "barcode-qscv",
            storageBucket: "barcode-qscv.appspot.com",
            messagingSenderId: "204134538515",
            appId: "1:204134538515:web:394a3880ced41726950eeb"
        };
        
        // Data awal (hanya akan digunakan jika database kosong)
        const INITIAL_EMPLOYEES = [
            { nama: "P.Risky", nik: "2015046856", password: "Ekeng12345" },
            { nama: "Vicky", nik: "2015664852", password: "Vicki123" },
            { nama: "Dwi", nik: "2015514964", password: "Dwipranoto2" },
            { nama: "Maura", nik: "2015412239", password: "Maura123" },
            { nama: "B.Tri", nik: "2013202915", password: "Trianasetia123" },
            { nama: "Putri", nik: "2015380808", password: "Nap231203" },
            { nama: "Arya", nik: "2015608197", password: "Arya1234567" },
            { nama: "Ipin", nik: "2015500732", password: "Angkasa22" },
            { nama: "B.ema", nik: "2015355437", password: "Ema11223" },
            { nama: "Yoga", nik: "2015502008", password: "Yoga123123" },
        ];

        // Inisialisasi Firebase
        let employees = [];
        let database;
        let employeeRef;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            employeeRef = database.ref('karyawan/list'); // Node data untuk Karyawan
        } catch (e) {
            console.error("FIREBASE ERROR: Gagal menginisialisasi Firebase. Cek konfigurasi Anda.", e);
            alert("‚ö†Ô∏è Error Cloud: Gagal terhubung ke database. Data akan disimpan secara lokal (hanya di perangkat ini).");
        }


        // ===================================================================================
        // FUNGSI PERSISTENSI DATA CLOUD
        // ===================================================================================

        function saveEmployeesToCloud() {
            if (!database) return;
            employeeRef.set(employees)
                .then(() => {
                    console.log("Data berhasil disimpan ke Cloud!");
                })
                .catch((error) => {
                    console.error("Gagal menyimpan ke Cloud:", error);
                    alert("Gagal menyimpan data karyawan ke Cloud. Cek koneksi internet Anda.");
                });
        }
        
        function loadEmployeesFromCloud() {
            if (!database) {
                employees = INITIAL_EMPLOYEES;
                renderEmployeeList();
                return;
            }

            employeeRef.once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data && Array.isArray(data) && data.length > 0) {
                        employees = data;
                    } else {
                        employees = INITIAL_EMPLOYEES;
                        saveEmployeesToCloud(); 
                    }
                    renderEmployeeList();
                })
                .catch((error) => {
                    console.error("Gagal memuat dari Cloud:", error);
                    employees = INITIAL_EMPLOYEES;
                    renderEmployeeList();
                });
        }

        // ===================================================================================
        // FUNGSI UTAMA DAN EVENT LISTENER
        // ===================================================================================
        
        const listContainer = document.getElementById('employee-list-container');
        const modal = document.getElementById('modal');
        const closeModal = document.querySelector('.close-btn');
        const showAddFormBtn = document.getElementById('show-add-form-btn');
        const addFormDiv = document.getElementById('add-employee-form');
        const newEmployeeForm = document.getElementById('new-employee-form');
        const editEmployeeForm = document.getElementById('edit-employee-form');
        const deleteEmployeeBtn = document.getElementById('delete-employee-btn');


        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const textToCopy = element.textContent;

            navigator.clipboard.writeText(textToCopy).then(() => {
                alert(`Berhasil menyalin: ${textToCopy}`);
            }).catch(err => {
                const tempInput = document.createElement('textarea');
                tempInput.value = textToCopy;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert(`Berhasil menyalin: ${textToCopy}`);
            });
        }
        window.copyToClipboard = copyToClipboard; 


        function renderEmployeeList() {
            listContainer.innerHTML = ''; 

            if (employees.length === 0) {
                listContainer.innerHTML = '<p style="color:#dc3545;">Daftar karyawan kosong. Silakan tambahkan karyawan baru.</p>';
                return;
            }

            employees.forEach((employee, index) => {
                const item = document.createElement('div');
                item.className = 'employee-item';
                item.setAttribute('data-index', index);
                item.innerHTML = `<span>${index + 1}. ${employee.nama}</span>`; 
                
                item.addEventListener('click', () => showBarcodeModal(index));
                
                listContainer.appendChild(item);
            });
        }

        function showBarcodeModal(index) {
            const employee = employees[index];
            document.getElementById('qrcode-nik').innerHTML = '';
            document.getElementById('qrcode-password').innerHTML = '';
            
            new QRCode(document.getElementById('qrcode-nik'), { text: employee.nik, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
            new QRCode(document.getElementById('qrcode-password'), { text: employee.password, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
            
            document.getElementById('data-nik').textContent = employee.nik;
            document.getElementById('data-password').textContent = employee.password;
            document.getElementById('modal-title').textContent = `Barcode & Edit (${employee.nama})`;

            document.getElementById('edit-index').value = index;
            document.getElementById('edit-nama').value = employee.nama;
            document.getElementById('edit-nik').value = employee.nik;
            document.getElementById('edit-password').value = employee.password;

            modal.style.display = 'block';
        }

        closeModal.addEventListener('click', () => { modal.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target == modal) { modal.style.display = 'none'; } });

        showAddFormBtn.addEventListener('click', () => {
            const isHidden = addFormDiv.style.display === 'none' || addFormDiv.style.display === '';
            addFormDiv.style.display = isHidden ? 'block' : 'none';
            showAddFormBtn.textContent = isHidden ? 'Sembunyikan Formulir' : 'Tambah Daftar Karyawan ‚ûï';
        });
        
        newEmployeeForm.addEventListener('submit', (event) => {
            event.preventDefault();
            
            const newEmployee = {
                nama: document.getElementById('new-nama').value,
                nik: document.getElementById('new-nik').value,
                password: document.getElementById('new-password').value
            };
            
            employees.push(newEmployee);
            newEmployeeForm.reset();
            saveEmployeesToCloud(); 
            renderEmployeeList();
            
            addFormDiv.style.display = 'none';
            showAddFormBtn.textContent = 'Tambah Daftar Karyawan ‚ûï';
            alert(`Karyawan ${newEmployee.nama} berhasil ditambahkan!`);
        });

        editEmployeeForm.addEventListener('submit', (event) => {
            event.preventDefault();
            
            const index = document.getElementById('edit-index').value;
            
            employees[index] = {
                nama: document.getElementById('edit-nama').value,
                nik: document.getElementById('edit-nik').value,
                password: document.getElementById('edit-password').value
            };
            
            saveEmployeesToCloud(); 
            renderEmployeeList();
            modal.style.display = 'none';
            alert(`Data karyawan ${employees[index].nama} berhasil diubah!`);
        });
        
        deleteEmployeeBtn.addEventListener('click', () => {
            const index = document.getElementById('edit-index').value;
            const nama = employees[index].nama;
            
            if (confirm(`Apakah Anda yakin ingin menghapus karyawan ${nama}?`)) {
                employees.splice(index, 1); 
                saveEmployeesToCloud(); 
                renderEmployeeList();
                modal.style.display = 'none';
                alert(`Karyawan ${nama} berhasil dihapus.`);
            }
        });

        // MUAT DATA DARI CLOUD SAAT HALAMAN DIMUAT
        loadEmployeesFromCloud();
    </script>

</body>
</html>
