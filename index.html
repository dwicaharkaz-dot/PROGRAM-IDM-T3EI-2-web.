<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock Opname IDM T3EI</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:0; background:#ecf0f1; }
    .header-container { display:flex; justify-content:space-between; align-items:center;
                  padding:10px 20px; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .header-container img { height:40px; }
    .header-bg { display:flex; height:10px; }
    .color-red{flex:1;background:#e74c3c}.color-blue{flex:1;background:#3498db}.color-yellow{flex:1;background:#f1c40f}
    header h1 { text-align:center; font-size:2em; margin:20px 0; color:#333; }
    .container { width:90%; max-width:1200px; margin:20px auto; background:white; padding:20px;
                 border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,.1); }
    textarea { width:80%; height:120px; padding:10px; border:1px solid #ccc; border-radius:5px; }
    button { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; }
    .input-form button { background:#2ecc71; color:white; }
    .search-bar { text-align:center; margin:12px 0; }
    .search-bar input { width:70%; max-width:500px; padding:10px; border:1px solid #ddd;
                        border-radius:25px; text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f2f2f2; }
    .stok-fisik-cell input { width:120px; padding:5px; }
    .selisih-negatif{color:#e74c3c;font-weight:bold}.selisih-positif{color:#27ae60;font-weight:bold}
    .download-btn { background:#3498db; color:white; margin:10px 5px; }
    .section-title { text-align:center; font-size:1.5em; color:#555; margin:30px 0 10px; }
    .total-box { text-align:center; font-size:1.1em; font-weight:bold; padding:10px;
                 border:2px dashed #3498db; border-radius:8px; background:#e8f5ff; margin-top:10px; }
    .controls-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px; }
    .small { padding:8px 12px; font-size:0.95rem; }
    /* Menghilangkan elemen saat pencarian */
    .hidden { display: none; }
    
    /* --- STYLING NAVIGASI BARU (Menu Pop-up) --- */
    .menu-container {
        position: relative; 
        display: flex; 
        align-items: center;
    }
    .menu-button {
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
      background-color: #f1c40f; 
      color: #333;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 101; 
      margin-right: 20px; 
    }
    .menu-popup {
        display: none; 
        position: absolute;
        top: 100%; 
        left: 0; 
        min-width: 180px;
        border: 1px solid #ccc;
        padding: 15px;
        background-color: white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        border-radius: 8px;
        z-index: 100; 
    }
    .popup-button {
        display: block; 
        width: 100%;
        padding: 10px;
        margin-bottom: 8px;
        background-color: #3498db; 
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
        font-size: 0.95rem;
        transition: background-color 0.2s;
    }
    .popup-button:hover {
        background-color: #2980b9;
    }
    /* --- AKHIR STYLING NAVIGASI BARU --- */
    
  </style>
</head>
<body>

  <div class="header-container">
    <div class="menu-container">
        <button class="menu-button" onclick="toggleMenuPopup()">Menu ☰</button>
        <div id="menuPopup" class="menu-popup">
            <p style="margin-top: 0; font-weight: bold;">Pilih Aksi:</p>
            
            <button class="popup-button" onclick="goToBarcodeESS()">Barcode ESS</button>
            
            <button class="popup-button" onclick="goToLaporanSales()">Laporan Sales</button>
            <button class="popup-button" onclick="goToSoProdsus()">So Prodsus</button>
            <button class="popup-button" onclick="goToLaporanProdsus()">Laporan Prodsus</button> <button class="popup-button" onclick="goToEditFoto()">Edit Foto</button>
        </div>
    </div>
    
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Logo_Indomaret.png" alt="Logo Indomaret">
    <h1>STOCK OPNAME IDM T3EI</h1>
    <div></div> </div>
  <div class="header-bg"><div class="color-red"></div><div class="color-blue"></div><div class="color-yellow"></div></div>

  <div class="container">
    <h2 class="section-title">Input Data Stok Sistem (Multi-Baris)</h2>
    <div class="input-form">
      <textarea id="dataInput" placeholder="Contoh format baru:&#10;01| Dancow Fortigro Susu ... Instant 780g&#10;      10006259 | Rp 100.200 | STOK: 3&#10;____________________________________&#10;..."></textarea><br>
      <div class="controls-row">
        <button class="small" onclick="addData()">Tambah Stok</button>
        <button class="small download-btn" style="background:#e74c3c;" onclick="resetStok()">Reset Stok Sistem</button>
        <button class="small download-btn" id="restoreButton" style="background:#f1c40f; display:none;" onclick="restoreData()">Pulihkan Data</button>
        <button class="small" onclick="fillExample()">Isi Contoh 5 Barang</button>
      </div>
    </div>

    <h2 class="section-title">Import Data Stok Sistem (XLSX)</h2>
    <div class="controls-row">
      <input type="file" id="fileInput" accept=".xlsx" />
    </div>

    <h2 class="section-title">Pencarian</h2>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Cari berdasarkan PLU atau Nama Barang... (ketik lalu tunggu)" />
    </div>

    <h2 class="section-title">Data Stok Fisik</h2>
    <table id="stokTable" role="table" aria-label="Tabel stok fisik">
      <thead>
        <tr>
          <th>No</th><th>PLU</th><th>Nama Barang</th><th>Harga</th><th>Stok Sistem</th>
          <th>Stok Fisik</th><th>Selisih QTY</th><th>Selisih Rupiah</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="text-align:center; margin-top:12px;">
      <button class="download-btn" onclick="downloadXLSX('stokTable','Semua_Data_Stock_Opname.xlsx')">Download Semua Data (XLSX)</button>
    </div>
  </div>

  <div class="container" id="selisihContainer" style="display:none;">
    <h2 class="section-title">Item Selisih</h2>

    <h3 style="margin-top:0">Item Minus</h3>
    <table id="selisihMinusTable">
      <thead><tr><th>No</th><th>PLU</th><th>Nama Barang</th><th>Stok Sistem</th><th>Stok Fisik</th><th>Selisih QTY</th><th>Selisih Rupiah</th></tr></thead>
      <tbody></tbody>
    </table>

    <h3 style="margin-top:18px">Item Plus</h3>
    <table id="selisihPlusTable">
      <thead><tr><th>No</th><th>PLU</th><th>Nama Barang</th><th>Stok Sistem</th><th>Stok Fisik</th><th>Selisih QTY</th><th>Selisih Rupiah</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="total-box" id="totalMinus">Total Rupiah Minus: Rp 0</div>
    <div class="total-box" id="totalPlus">Total Rupiah Plus: Rp 0</div>
    <div class="total-box" id="totalAll">Total Selisih Rupiah: Rp 0</div>

    <div style="text-align:center; margin-top:12px;">
      <button class="download-btn" onclick="downloadSelisih()">Download Data Selisih (XLSX)</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // --- START SCRIPT UNTUK MENU & NAVIGASI ---
    function toggleMenuPopup() {
        var popup = document.getElementById('menuPopup');
        if (popup.style.display === 'none' || popup.style.display === '') {
            popup.style.display = 'block';
        } else {
            popup.style.display = 'none';
        }
    }

    // FUNGSI NAVIGASI KE FILE ANDA
    function goToLaporanSales() {
        window.location.href = 'laporan_sales.html'; 
    }

    function goToSoProdsus() {
        window.location.href = 'so_prodsus.html';     
    }

    // FUNGSI BARU UNTUK LAPORAN PRODSUS
    function goToLaporanProdsus() {
        window.location.href = 'laporan_prodsus.html';     
    }

    function goToEditFoto() {
        window.location.href = 'edit_foto.html';     
    }
    
    // FUNGSI NAVIGASI KE BARCODE ESS
    function goToBarcodeESS() {
        // Harus mengarah ke file yang kita buat di Bagian 2
        window.location.href = 'barcode_ess.html'; 
    }

    document.addEventListener('click', function(event) {
        var menuBtn = document.querySelector('.menu-button');
        var popup = document.getElementById('menuPopup');
        
        var isClickInside = menuBtn.contains(event.target) || popup.contains(event.target);
        
        if (!isClickInside && popup.style.display === 'block') {
            popup.style.display = 'none';
        }
    });
    // --- END SCRIPT NAVIGASI ---

    // ===================================================================================
    // ☁️ FIREBASE CLOUD CONFIGURATION & INIT ☁️ (Untuk Stock Opname)
    // ===================================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyDlaMjPJDQPQMZMTPSLDOuI_j47kKJEJmSWK", 
        authDomain: "barcode-qscv.firebaseapp.com",
        databaseURL: "https://barcode-qscv-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "barcode-qscv",
        storageBucket: "barcode-qscv.appspot.com",
        messagingSenderId: "204134538515",
        appId: "1:204134538515:web:394a3880ced41726950eeb"
    };

    let allItems = [];
    let tempData = []; 
    let database;
    let stockOpnameRef;

    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        stockOpnameRef = database.ref('stock_opname/list'); // Node data untuk Stock Opname
    } catch (e) {
        console.error("FIREBASE ERROR: Gagal menginisialisasi Firebase.", e);
        alert("⚠️ Error Cloud: Gagal terhubung ke database. Data tidak akan tersinkronisasi. Mohon cek koneksi dan konfigurasi Anda.");
    }

    // Fungsi untuk menyimpan data ke Cloud
    function saveToCloud() {
      if (!database || !stockOpnameRef) return;
      const itemsToStore = allItems.map(({ selisihQty, selisihRp, ...rest }) => rest);
      stockOpnameRef.set(itemsToStore)
        .then(() => { console.log("Data berhasil disimpan ke Cloud."); })
        .catch((error) => { console.error("Gagal menyimpan ke Cloud:", error); });
    }

    // Fungsi untuk memuat data dari Cloud
    function loadFromCloud() {
      if (!database || !stockOpnameRef) return;
      stockOpnameRef.once('value')
        .then((snapshot) => {
          const data = snapshot.val();
          if (data && Array.isArray(data)) {
            allItems = data;
          } else {
            allItems = []; 
          }
          renderTable(); 
        })
        .catch((error) => {
          console.error("Gagal memuat data dari Cloud:", error);
          alert("Gagal memuat data dari Cloud. Menggunakan data kosong/awal.");
          renderTable();
        });
    }
    // ===================================================================================
    // AKHIR FIREBASE CLOUD CONFIGURATION
    // ===================================================================================

    // ... (Semua kode JavaScript Stock Opname lainnya di sini) ...
    
    // DOM
    const tableBody = document.querySelector('#stokTable tbody');
    const selisihMinusBody = document.querySelector('#selisihMinusTable tbody');
    const selisihPlusBody = document.querySelector('#selisihPlusTable tbody');
    const selisihContainer = document.getElementById('selisihContainer');
    const totalMinusEl = document.getElementById('totalMinus');
    const totalPlusEl = document.getElementById('totalPlus');
    const totalAllEl = document.getElementById('totalAll');
    const searchInput = document.getElementById('searchInput');
    const restoreButton = document.getElementById('restoreButton');
    const dataInputEl = document.getElementById('dataInput'); 

    // Helper untuk format Rupiah
    function formatRupiah(number) {
        return 'Rp ' + (Number(number) || 0).toLocaleString('id-ID');
    }

    // Tambah data manual - LOGIKA TELAH DIPERBARUI
    function addData(){
      const rawInput = dataInputEl.value;
      
      const cleanLines = rawInput.split('\n')
        .map(line => line.replace(/[\u200B-\u200D\uFEFF\u00A0]/g, '').trim()) 
        .filter(line => line !== '' && !line.startsWith('____'));
      
      const parsedItems = [];
      
      for(let i = 0; i < cleanLines.length; i += 2){ 
        if(i + 1 < cleanLines.length){
          const namaLine = cleanLines[i];
          const dataLine = cleanLines[i+1];
          
          const dataLineMatch = dataLine.match(/^\s*(\d{8,})\s*\|/); 
          
          if(namaLine.includes('|') && dataLineMatch){ 

              const namaProduk = namaLine.split('|').slice(1).join('|').trim();
              
              const plu = dataLineMatch[1]; 
              
              const hargaMatch = dataLine.match(/Rp\s*([\d\.,]+)/i); 
              const harga = Number(hargaMatch?.[1].replace(/[^\d]/g, '')) || 0; 
              const stokSistem = Number(dataLine.match(/STOK:\s*(\d+)/i)?.[1]) || 0;
              
              if(plu){
                  parsedItems.push({
                    plu: String(plu),
                    nama: String(namaProduk),
                    harga: harga,
                    stokSistem: stokSistem,
                    stokFisik: 0
                  });
              }
          }
        }
      }
      
      const existingPlu = new Set(allItems.map(item => String(item.plu).trim()));
      const newItems = [];
      
      for(const item of parsedItems){
          const itemPlu = String(item.plu).trim();
          if (!existingPlu.has(itemPlu)) {
              newItems.push(item);
              existingPlu.add(itemPlu); 
          }
      }
      
      if(newItems.length){
        allItems = allItems.concat(newItems);
        renderTable();
      }
      dataInputEl.value = '';
    }

    // contoh isi (opsional) - DIPERBAIKI agar menggunakan format baru
    function fillExample(){
      const example = [
        "01| Dancow Fortigro Susu ... Instant 780g",
        "      10006259 | Rp 100.200 | STOK: 3",
        "____________________________________",
        "02| Diabetasol Susu Formula ... Vanila 170G",
        "      10000578 | Rp 51.700 | STOK: 2",
        "____________________________________",
        "03| Entrasol Gold Susu ... Vanila 2X280g",
        "      20087580 | Rp 115.600 | STOK: 4",
        "____________________________________",
        "04| Zee Susu Bubuk ... Chocolate 340G",
        "      20027848 | Rp 49.900 | STOK: 4",
        "____________________________________",
        "05| Halim Rokok Filter 20'S",
        "      20045093 | Rp 27.400 | STOK: 2"
      ].join('\n');
      
      dataInputEl.value = example; 
    }

    // reset -> hapus semua data stok sistem
    function resetStok(){
      tempData = JSON.parse(JSON.stringify(allItems)); 
      allItems = [];
      renderTable();
      selisihMinusBody.innerHTML = '';
      selisihPlusBody.innerHTML = '';
      selisihContainer.style.display = 'none';
      totalMinusEl.textContent = 'Total Rupiah Minus: Rp 0';
      totalPlusEl.textContent = 'Total Rupiah Plus: Rp 0';
      totalAllEl.textContent = 'Total Selisih Rupiah: Rp 0';
      const fileInput = document.getElementById('fileInput');
      if(fileInput) fileInput.value = '';
      saveToCloud(); 
      if(tempData.length > 0) {
        restoreButton.style.display = 'block';
      }
    }

    // Fungsi untuk memulihkan data (tetap lokal/tempData)
    function restoreData(){
      allItems = JSON.parse(JSON.stringify(tempData));
      renderTable();
      restoreButton.style.display = 'none';
      saveToCloud(); 
    }

    // render main table
    function renderTable(){
      tableBody.innerHTML = '';
      allItems.forEach((it, index)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${escapeHtml(String(it.plu))}</td>
          <td>${escapeHtml(String(it.nama))}</td>
          <td>${formatRupiah(it.harga)}</td>
          <td>${escapeHtml(String(it.stokSistem))}</td>
          <td class="stok-fisik-cell"><input type="text" inputmode="numeric" value="${it.stokFisik || ''}" onblur="updateFisik('${escapeJs(it.plu)}', this)"></td>
          <td class="selisih-qty"></td>
          <td class="selisih-rp"></td>
        `;
        tableBody.appendChild(tr);
      });
      updateAll();
    }

    // update stok fisik (mendukung input "2,2,3")
    function updateFisik(plu, inputEl){
      const pluKey = String(plu).trim();
      const item = allItems.find(i => String(i.plu).trim() === pluKey);
      if(!item) return;
      
      const parts = String(inputEl.value || '').split(/[^0-9]+/).map(v => parseInt(v.trim()) || 0);
      const total = parts.reduce((a,b)=>a+b, 0);
      
      item.stokFisik = total;
      inputEl.value = total;
      updateAll();
      saveToCloud(); 
    }

    // update selisih, tabel minus/plus, totals, urutan & simpan array untuk export
    function updateAll(){
      selisihMinusBody.innerHTML = '';
      selisihPlusBody.innerHTML = '';
      let totalMinusRp = 0, totalPlusRp = 0;
      let anySelisih = false;
      const minusItems = [], plusItems = [];
      
      allItems.forEach(item => {
        const qty = (Number(item.stokFisik) || 0) - (Number(item.stokSistem) || 0);
        const rp = qty * (Number(item.harga) || 0);
        item.selisihQty = qty;
        item.selisihRp = rp;

        if (qty !== 0) {
          anySelisih = true;
          if (qty < 0) { minusItems.push(item); totalMinusRp += rp; }
          else { plusItems.push(item); totalPlusRp += rp; }
        }
      });
      
      [...tableBody.rows].forEach(tr => {
        const pluCell = tr.cells[1] && tr.cells[1].textContent ? tr.cells[1].textContent.trim() : '';
        const item = allItems.find(i => String(i.plu).trim() === pluCell);
        if (item) {
          const qcell = tr.querySelector('.selisih-qty');
          const rcell = tr.querySelector('.selisih-rp');
          qcell.textContent = item.selisihQty;
          rcell.textContent = formatRupiah(item.selisihRp); 
          qcell.className = 'selisih-qty';
          rcell.className = 'selisih-rp';
          if (item.selisihQty < 0) { qcell.classList.add('selisih-negatif'); rcell.classList.add('selisih-negatif'); }
          else if (item.selisihQty > 0) { qcell.classList.add('selisih-positif'); rcell.classList.add('selisih-positif'); }
        }
      });

      minusItems.sort((a,b) => Math.abs(b.selisihRp) - Math.abs(a.selisihRp));
      plusItems.sort((a,b) => Math.abs(b.selisihRp) - Math.abs(a.selisihRp));
      
      minusItems.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(r.plu)}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.stokSistem)}</td><td>${escapeHtml(r.stokFisik)}</td><td>${escapeHtml(r.selisihQty)}</td><td>${formatRupiah(r.selisihRp)}</td>`; 
        selisihMinusBody.appendChild(row);
      });
      plusItems.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(r.plu)}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.stokSistem)}</td><td>${escapeHtml(r.stokFisik)}</td><td>${escapeHtml(r.selisihQty)}</td><td>${formatRupiah(r.selisihRp)}</td>`; 
        selisihPlusBody.appendChild(row);
      });

      selisihContainer.style.display = anySelisih ? 'block' : 'none';
      totalMinusEl.textContent = 'Total Rupiah Minus: ' + formatRupiah(totalMinusRp);
      totalPlusEl.textContent  = 'Total Rupiah Plus: ' + formatRupiah(totalPlusRp);
      totalAllEl.textContent   = 'Total Selisih Rupiah: ' + formatRupiah(totalMinusRp + totalPlusRp);

      window._minusItems = minusItems;
      window._plusItems = plusItems;
      window._totalMinusRp = totalMinusRp;
      window._totalPlusRp = totalPlusRp;
      
      saveToCloud(); 
    }

    // Pencarian: menyembunyikan/menampilkan baris
    function performSearch(){
      const q = (searchInput.value || '').toString().trim().toLowerCase();
      const rows = document.querySelectorAll('#stokTable tbody tr');
      let visibleCount = 0;
      rows.forEach(tr => {
        if(tr.cells.length > 2) {
            const plu = tr.cells[1].textContent.trim().toLowerCase();
            const name = tr.cells[2].textContent.trim().toLowerCase();
            const isMatch = plu.includes(q) || name.includes(q);
            tr.style.display = isMatch ? '' : 'none';
            
            if (isMatch) {
                tr.cells[0].textContent = ++visibleCount;
            }
        }
      });
    }

    // attach search listener (debounce kecil)
    let _searchTimer = null;
    searchInput.addEventListener('input', function(){
      if(_searchTimer) clearTimeout(_searchTimer);
      _searchTimer = setTimeout(() => { performSearch(); _searchTimer = null; }, 150);
    });
    
    // Import dari XLSX
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    function handleFile(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.Sheets[0]];
        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: ["PLU","Nama Barang","Harga","Stok Sistem","Stok Fisik"] });
        
        const newItems = [];
        rows.slice(1).forEach(r=>{
          if(r && r.PLU){
            newItems.push({
              plu: String(r.PLU),
              nama: String(r['Nama Barang'] || ''),
              harga: Number(r.Harga) || 0,
              stokSistem: Number(r['Stok Sistem']) || 0,
              stokFisik: Number(r['Stok Fisik']) || 0
            });
          }
        });

        const existingPlu = new Set(allItems.map(item => String(item.plu).trim()));
        const uniqueNewItems = newItems.filter(item => !existingPlu.has(String(item.plu).trim()));

        allItems = allItems.concat(uniqueNewItems);
        renderTable();
        saveToCloud(); 
      };
      reader.readAsArrayBuffer(file);
    }

    // Download semua data
    function downloadXLSX(tableId, filename){
      const table = document.getElementById(tableId);
      const rowsToExport = [...table.querySelectorAll('tbody tr')].filter(tr => tr.style.display !== 'none');
      const dataToExport = [['No', 'PLU', 'Nama Barang', 'Harga', 'Stok Sistem', 'Stok Fisik', 'Selisih QTY', 'Selisih Rupiah']];
      
      rowsToExport.forEach(row => {
          const cells = [...row.cells];
          const stokFisikValue = cells[5].querySelector('input') ? cells[5].querySelector('input').value : cells[5].textContent;
          
          const hargaClean = cells[3].textContent.replace('Rp', '').replace(/\./g, '').trim();
          const selisihRpText = cells[7].textContent.replace('Rp', '').replace(/\./g, '').trim();

          const rowData = [
              cells[0].textContent,
              cells[1].textContent,
              cells[2].textContent,
              Number(hargaClean), 
              cells[4].textContent,
              stokFisikValue,
              cells[6].textContent,
              Number(selisihRpText) 
          ];
          dataToExport.push(rowData);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Stock Opname");
      XLSX.writeFile(wb, filename);
    }

    // Download selisih
    function downloadSelisih(){
      const minus = window._minusItems || [];
      const plus = window._plusItems || [];
      const totalMinus = window._totalMinusRp || 0;
      const totalPlus = window._totalPlusRp || 0;

      const aoa = [];
      aoa.push(["=== ITEM MINUS ==="]);
      aoa.push(["No","PLU","Nama Barang","Stok Sistem","Stok Fisik","Selisih QTY","Selisih Rupiah"]);
      minus.forEach((r, i) => aoa.push([i+1, r.plu, r.nama, r.stokSistem, r.stokFisik, r.selisihQty, r.selisihRp]));
      aoa.push([]);
      aoa.push(["Total Rupiah Minus","","","","","", totalMinus]);
      aoa.push([]);
      aoa.push(["=== ITEM PLUS ==="]);
      aoa.push(["No","PLU","Nama Barang","Stok Sistem","Stok Fisik","Selisih QTY","Selisih Rupiah"]);
      plus.forEach((r, i) => aoa.push([i+1, r.plu, r.nama, r.stokSistem, r.stokFisik, r.selisihQty, r.selisihRp]));
      aoa.push([]);
      aoa.push(["TOTAL SELISIH RUPIAH","","","","","", totalMinus + totalPlus]);

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data Selisih");
      XLSX.writeFile(wb, "Data_Selisih.xlsx");
    }

    // helper: escape HTML to avoid XSS in table rendering
    function escapeHtml(str){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    // helper to escape JS string used in inline onblur attribute
    function escapeJs(s){
      return String(s).replace(/'/g,"\\'");
    }

    // 1. Muat data dari Cloud saat aplikasi dimulai
    loadFromCloud();
    
  </script>
</body>
</html>
