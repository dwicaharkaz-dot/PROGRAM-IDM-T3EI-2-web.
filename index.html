<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock Opname IDM T3EI</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:0; background:#ecf0f1; }
    .header-container { display:flex; justify-content:space-between; align-items:center;
                  padding:10px 20px; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .header-container img { height:40px; }
    .header-bg { display:flex; height:10px; }
    .color-red{flex:1;background:#e74c3c}.color-blue{flex:1;background:#3498db}.color-yellow{flex:1;background:#f1c40f}
    header h1 { text-align:center; font-size:2em; margin:20px 0; color:#333; }
    .container { width:90%; max-width:1200px; margin:20px auto; background:white; padding:20px;
                 border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,.1); }
    textarea { width:80%; height:120px; padding:10px; border:1px solid #ccc; border-radius:5px; }
    button { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; }
    .input-form button { background:#2ecc71; color:white; }
    .search-bar { text-align:center; margin:12px 0; }
    .search-bar input { width:70%; max-width:500px; padding:10px; border:1px solid #ddd;
                        border-radius:25px; text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f2f2f2; }
    .stok-fisik-cell input { width:120px; padding:5px; }
    .selisih-negatif{color:#e74c3c;font-weight:bold}.selisih-positif{color:#27ae60;font-weight:bold}
    .download-btn { background:#3498db; color:white; margin:10px 5px; }
    .section-title { text-align:center; font-size:1.5em; color:#555; margin:30px 0 10px; }
    .total-box { text-align:center; font-size:1.1em; font-weight:bold; padding:10px;
                 border:2px dashed #3498db; border-radius:8px; background:#e8f5ff; margin-top:10px; }
    .controls-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px; }
    .small { padding:8px 12px; font-size:0.95rem; }
    /* Menghilangkan elemen saat pencarian */
    .hidden { display: none; }
    
    /* --- STYLING NAVIGASI BARU --- */
    nav { text-align: center; margin: 20px 0; }
    
    /* Gaya Dasar Tombol Navigasi */
    nav a { 
      margin: 0 10px; 
      text-decoration: none; 
      font-weight: bold;
      display: inline-block; 
      padding: 8px 15px; 
      border-radius: 5px; 
      transition: background-color 0.3s, color 0.3s, transform 0.1s; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      color: white; 
      background-color: #3498db; /* Biru Default */
      border: 1px solid #2980b9;
    }
    
    /* Efek Hover untuk semua tombol */
    nav a:hover {
      background-color: #2980b9; 
      color: white;
      transform: translateY(-1px); /* Efek terangkat */
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }

    /* Gaya Spesifik untuk SO Prodsus */
    nav a[href="so_prodsus.html"] {
      background-color: #f1c40f; /* Kuning */
      color: #333; /* Teks gelap agar kontras */
      font-size: 1.05rem; 
      border: 1px solid #f39c12;
    }
    
    /* Efek Hover untuk SO Prodsus */
    nav a[href="so_prodsus.html"]:hover {
      background-color: #f39c12; /* Kuning lebih gelap */
    }
    /* --- AKHIR STYLING NAVIGASI BARU --- */
    
  </style>
</head>
<body>

  <nav>
    <a href="index.html">SO IDM (Reguler)</a>
    <a href="program_lain.html">LAPORAN SALES</a>
    <a href="so_prodsus.html">SO Prodsus</a>
  </nav>

  <div class="header-container">
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Logo_Indomaret.png" alt="Logo Indomaret">
    <h1>STOCK OPNAME IDM T3EI</h1>
    <div></div>
  </div>
  <div class="header-bg"><div class="color-red"></div><div class="color-blue"></div><div class="color-yellow"></div></div>

  <div class="container">
    <h2 class="section-title">Input Data Stok Sistem (Multi-Baris)</h2>
    <div class="input-form">
      <textarea id="dataInput" placeholder="Contoh format baru:&#10;01| Sgm Eksplor 3+... (Belajar) 600G&#10;ðŸ“¦ 20087025 | Rp 56.900 | STOK: 5&#10;____________________________________&#10;..."></textarea><br>
      <div class="controls-row">
        <button class="small" onclick="addData()">Tambah Stok</button>
        <button class="small download-btn" style="background:#e74c3c;" onclick="resetStok()">Reset Stok Sistem</button>
        <button class="small download-btn" id="restoreButton" style="background:#f1c40f; display:none;" onclick="restoreData()">Pulihkan Data</button>
        <button class="small" onclick="fillExample()">Isi Contoh 5 Barang</button>
      </div>
    </div>

    <h2 class="section-title">Import Data Stok Sistem (XLSX)</h2>
    <div class="controls-row">
      <input type="file" id="fileInput" accept=".xlsx" />
    </div>

    <h2 class="section-title">Pencarian</h2>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Cari berdasarkan PLU atau Nama Barang... (ketik lalu tunggu)" />
    </div>

    <h2 class="section-title">Data Stok Fisik</h2>
    <table id="stokTable" role="table" aria-label="Tabel stok fisik">
      <thead>
        <tr>
          <th>No</th><th>PLU</th><th>Nama Barang</th><th>Harga</th><th>Stok Sistem</th>
          <th>Stok Fisik</th><th>Selisih QTY</th><th>Selisih Rupiah</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="text-align:center; margin-top:12px;">
      <button class="download-btn" onclick="downloadXLSX('stokTable','Semua_Data_Stock_Opname.xlsx')">Download Semua Data (XLSX)</button>
    </div>
  </div>

  <div class="container" id="selisihContainer" style="display:none;">
    <h2 class="section-title">Item Selisih</h2>

    <h3 style="margin-top:0">Item Minus</h3>
    <table id="selisihMinusTable">
      <thead><tr><th>No</th><th>PLU</th><th>Nama Barang</th><th>Stok Sistem</th><th>Stok Fisik</th><th>Selisih QTY</th><th>Selisih Rupiah</th></tr></thead>
      <tbody></tbody>
    </table>

    <h3 style="margin-top:18px">Item Plus</h3>
    <table id="selisihPlusTable">
      <thead><tr><th>No</th><th>PLU</th><th>Nama Barang</th><th>Stok Sistem</th><th>Stok Fisik</th><th>Selisih QTY</th><th>Selisih Rupiah</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="total-box" id="totalMinus">Total Rupiah Minus: Rp 0</div>
    <div class="total-box" id="totalPlus">Total Rupiah Plus: Rp 0</div>
    <div class="total-box" id="totalAll">Total Selisih Rupiah: Rp 0</div>

    <div style="text-align:center; margin-top:12px;">
      <button class="download-btn" onclick="downloadSelisih()">Download Data Selisih (XLSX)</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // data
    let allItems = [];
    let tempData = [];

    // DOM
    const tableBody = document.querySelector('#stokTable tbody');
    const selisihMinusBody = document.querySelector('#selisihMinusTable tbody');
    const selisihPlusBody = document.querySelector('#selisihPlusTable tbody');
    const selisihContainer = document.getElementById('selisihContainer');
    const totalMinusEl = document.getElementById('totalMinus');
    const totalPlusEl = document.getElementById('totalPlus');
    const totalAllEl = document.getElementById('totalAll');
    const searchInput = document.getElementById('searchInput');
    const restoreButton = document.getElementById('restoreButton');
    const dataInputEl = document.getElementById('dataInput'); 

    // Helper untuk format Rupiah
    function formatRupiah(number) {
        return 'Rp ' + (Number(number) || 0).toLocaleString('id-ID');
    }

    // Tambah data manual - LOGIKA DIPERBAIKI
    function addData(){
      const rawInput = dataInputEl.value;
      
      const cleanLines = rawInput.split('\n')
        // Hapus zero-width spaces, non-breaking spaces, & trim
        .map(line => line.replace(/[\u200B-\u200D\uFEFF\u00A0]/g, '').trim()) 
        // Filter baris kosong dan separator
        .filter(line => line !== '' && !line.startsWith('____'));
      
      const parsedItems = [];
      
      // Perulangan per dua baris (pasangan nama dan data)
      for(let i = 0; i < cleanLines.length; i += 2){ 
        if(i + 1 < cleanLines.length){
          const namaLine = cleanLines[i];
          const dataLine = cleanLines[i+1];
          
          if(namaLine.includes('|') && dataLine.includes('ðŸ“¦')){ 

              // Mengambil nama produk setelah '|' pertama
              const namaProduk = namaLine.split('|').slice(1).join('|').trim();
              
              // Menggunakan regex untuk mendapatkan nilai
              const plu = dataLine.match(/ðŸ“¦\s*(\d+)/)?.[1] || '';
              // Harga: Mencari angka setelah 'Rp', lalu membersihkan non-digit
              const hargaMatch = dataLine.match(/Rp\s*([\d\.,]+)/i); 
              const harga = Number(hargaMatch?.[1].replace(/\D/g, '')) || 0;
              // Stok: Mencari angka setelah 'STOK:'
              const stokSistem = Number(dataLine.match(/STOK:\s*(\d+)/i)?.[1]) || 0;
              
              if(plu){
                  parsedItems.push({
                    plu: String(plu),
                    nama: String(namaProduk),
                    harga: harga,
                    stokSistem: stokSistem,
                    stokFisik: 0
                  });
              }
          }
        }
      }
      
      // Filter duplikasi setelah semua item di-parse
      const existingPlu = new Set(allItems.map(item => String(item.plu).trim()));
      const newItems = [];
      
      for(const item of parsedItems){
          const itemPlu = String(item.plu).trim();
          if (!existingPlu.has(itemPlu)) {
              newItems.push(item);
              existingPlu.add(itemPlu); // Mencegah duplikat dalam batch yang sama
          }
      }
      
      if(newItems.length){
        allItems = allItems.concat(newItems);
        renderTable();
      }
      dataInputEl.value = '';
    }

    // contoh isi (opsional) - DIPERBAIKI agar menggunakan dataInputEl
    function fillExample(){
      const example = [
        "01| Sgm Eksplor 3+... (Belajar) 600G",
        "ðŸ“¦ 20087025 | Rp 56.900 | STOK: 5",
        "____________________________________",
        "02| Sgm Ananda 1... Bulan 400G",
        "ðŸ“¦ 20040340 | Rp 43.200 | STOK: 5",
        "____________________________________",
        "03| Sgm Ananda 2... Bulan 400G",
        "ðŸ“¦ 20040312 | Rp 43.200 | STOK: 4",
        "____________________________________",
        "04| Sgm Eksplor 5+... Madu 900G",
        "ðŸ“¦ 20066494 | Rp 79.600 | STOK: 3",
        "____________________________________",
        "05| Bebelac 4... Bubuk Madu 400G/350G",
        "ðŸ“¦ 20035635 | Rp 68.100 | STOK: 2"
      ].join('\n');
      
      dataInputEl.value = example; // Menggunakan global dataInputEl
    }

    // reset -> hapus semua data stok sistem
    function resetStok(){
      tempData = JSON.parse(JSON.stringify(allItems));
      allItems = [];
      renderTable();
      selisihMinusBody.innerHTML = '';
      selisihPlusBody.innerHTML = '';
      selisihContainer.style.display = 'none';
      totalMinusEl.textContent = 'Total Rupiah Minus: Rp 0';
      totalPlusEl.textContent = 'Total Rupiah Plus: Rp 0';
      totalAllEl.textContent = 'Total Selisih Rupiah: Rp 0';
      const fileInput = document.getElementById('fileInput');
      if(fileInput) fileInput.value = '';
      saveToLocalStorage();
      if(tempData.length > 0) {
        restoreButton.style.display = 'block';
      }
    }

    // Fungsi untuk memulihkan data
    function restoreData(){
      allItems = JSON.parse(JSON.stringify(tempData));
      renderTable();
      restoreButton.style.display = 'none';
      saveToLocalStorage();
    }

    // render main table
    function renderTable(){
      tableBody.innerHTML = '';
      allItems.forEach((it, index)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${escapeHtml(String(it.plu))}</td>
          <td>${escapeHtml(String(it.nama))}</td>
          <td>${formatRupiah(it.harga)}</td>
          <td>${escapeHtml(String(it.stokSistem))}</td>
          <td class="stok-fisik-cell"><input type="text" inputmode="numeric" value="${it.stokFisik || ''}" onblur="updateFisik('${escapeJs(it.plu)}', this)"></td>
          <td class="selisih-qty"></td>
          <td class="selisih-rp"></td>
        `;
        tableBody.appendChild(tr);
      });
      updateAll();
      saveToLocalStorage();
    }

    // update stok fisik (mendukung input "2,2,3")
    function updateFisik(plu, inputEl){
      const pluKey = String(plu).trim();
      const item = allItems.find(i => String(i.plu).trim() === pluKey);
      if(!item) return;
      
      // Menggunakan regex untuk memisahkan angka yang dipisahkan oleh non-digit (termasuk koma)
      const parts = String(inputEl.value || '').split(/[^0-9]+/).map(v => parseInt(v.trim()) || 0);
      const total = parts.reduce((a,b)=>a+b, 0);
      
      item.stokFisik = total;
      inputEl.value = total;
      updateAll();
      saveToLocalStorage();
    }

    // update selisih, tabel minus/plus, totals, urutan & simpan array untuk export
    function updateAll(){
      selisihMinusBody.innerHTML = '';
      selisihPlusBody.innerHTML = '';
      let totalMinusRp = 0, totalPlusRp = 0;
      let anySelisih = false;
      const minusItems = [], plusItems = [];
      
      allItems.forEach(item => {
        const qty = (Number(item.stokFisik) || 0) - (Number(item.stokSistem) || 0);
        const rp = qty * (Number(item.harga) || 0);
        item.selisihQty = qty;
        item.selisihRp = rp;

        if (qty !== 0) {
          anySelisih = true;
          if (qty < 0) { minusItems.push(item); totalMinusRp += rp; }
          else { plusItems.push(item); totalPlusRp += rp; }
        }
      });
      
      [...tableBody.rows].forEach(tr => {
        const pluCell = tr.cells[1] && tr.cells[1].textContent ? tr.cells[1].textContent.trim() : '';
        const item = allItems.find(i => String(i.plu).trim() === pluCell);
        if (item) {
          const qcell = tr.querySelector('.selisih-qty');
          const rcell = tr.querySelector('.selisih-rp');
          qcell.textContent = item.selisihQty;
          rcell.textContent = formatRupiah(item.selisihRp); 
          qcell.className = 'selisih-qty';
          rcell.className = 'selisih-rp';
          if (item.selisihQty < 0) { qcell.classList.add('selisih-negatif'); rcell.classList.add('selisih-negatif'); }
          else if (item.selisihQty > 0) { qcell.classList.add('selisih-positif'); rcell.classList.add('selisih-positif'); }
        }
      });

      minusItems.sort((a,b) => Math.abs(b.selisihRp) - Math.abs(a.selisihRp));
      plusItems.sort((a,b) => Math.abs(b.selisihRp) - Math.abs(a.selisihRp));
      
      minusItems.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(r.plu)}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.stokSistem)}</td><td>${escapeHtml(r.stokFisik)}</td><td>${escapeHtml(r.selisihQty)}</td><td>${formatRupiah(r.selisihRp)}</td>`; 
        selisihMinusBody.appendChild(row);
      });
      plusItems.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(r.plu)}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.stokSistem)}</td><td>${escapeHtml(r.stokFisik)}</td><td>${escapeHtml(r.selisihQty)}</td><td>${formatRupiah(r.selisihRp)}</td>`; 
        selisihPlusBody.appendChild(row);
      });

      selisihContainer.style.display = anySelisih ? 'block' : 'none';
      totalMinusEl.textContent = 'Total Rupiah Minus: ' + formatRupiah(totalMinusRp);
      totalPlusEl.textContent  = 'Total Rupiah Plus: ' + formatRupiah(totalPlusRp);
      totalAllEl.textContent   = 'Total Selisih Rupiah: ' + formatRupiah(totalMinusRp + totalPlusRp);

      window._minusItems = minusItems;
      window._plusItems = plusItems;
      window._totalMinusRp = totalMinusRp;
      window._totalPlusRp = totalPlusRp;
    }

    // Pencarian: menyembunyikan/menampilkan baris
    function performSearch(){
      const q = (searchInput.value || '').toString().trim().toLowerCase();
      const rows = document.querySelectorAll('#stokTable tbody tr');
      let visibleCount = 0;
      rows.forEach(tr => {
        // Hanya memproses baris yang memiliki sel (untuk menghindari baris kosong yang mungkin ada)
        if(tr.cells.length > 2) {
            const plu = tr.cells[1].textContent.trim().toLowerCase();
            const name = tr.cells[2].textContent.trim().toLowerCase();
            const isMatch = plu.includes(q) || name.includes(q);
            tr.style.display = isMatch ? '' : 'none';
            
            if (isMatch) {
                tr.cells[0].textContent = ++visibleCount;
            }
        }
      });
    }

    // attach search listener (debounce kecil)
    let _searchTimer = null;
    searchInput.addEventListener('input', function(){
      if(_searchTimer) clearTimeout(_searchTimer);
      _searchTimer = setTimeout(() => { performSearch(); _searchTimer = null; }, 150);
    });
    
    // Import dari XLSX
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    function handleFile(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        // Menggunakan skip_header: true dan kemudian memproses objek
        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: ["PLU","Nama Barang","Harga","Stok Sistem","Stok Fisik"] });
        
        const newItems = [];
        rows.slice(1).forEach(r=>{
          // Mengambil nilai dari kolom-kolom yang diharapkan
          if(r && r.PLU){
            newItems.push({
              plu: String(r.PLU),
              nama: String(r['Nama Barang'] || ''),
              // Mengubah string menjadi angka
              harga: Number(r.Harga) || 0,
              stokSistem: Number(r['Stok Sistem']) || 0,
              stokFisik: Number(r['Stok Fisik']) || 0
            });
          }
        });

        // Mencegah duplikasi: tambahkan hanya PLU yang belum ada
        const existingPlu = new Set(allItems.map(item => String(item.plu).trim()));
        const uniqueNewItems = newItems.filter(item => !existingPlu.has(String(item.plu).trim()));

        allItems = allItems.concat(uniqueNewItems);
        renderTable();
      };
      reader.readAsArrayBuffer(file);
    }

    // Download semua data
    function downloadXLSX(tableId, filename){
      const table = document.getElementById(tableId);
      const rowsToExport = [...table.querySelectorAll('tbody tr')].filter(tr => tr.style.display !== 'none');
      const dataToExport = [['No', 'PLU', 'Nama Barang', 'Harga', 'Stok Sistem', 'Stok Fisik', 'Selisih QTY', 'Selisih Rupiah']];
      
      rowsToExport.forEach(row => {
          const cells = [...row.cells];
          // Mengambil nilai dari input untuk Stok Fisik, atau textContent jika tidak ada input
          const stokFisikValue = cells[5].querySelector('input') ? cells[5].querySelector('input').value : cells[5].textContent;
          
          // Mengambil nilai Rupiah dalam bentuk angka (tanpa Rp) untuk ekspor yang bersih
          const hargaClean = cells[3].textContent.replace('Rp', '').replace(/\./g, '').trim();
          const selisihRpText = cells[7].textContent.replace('Rp', '').replace(/\./g, '').trim();

          const rowData = [
              cells[0].textContent,
              cells[1].textContent,
              cells[2].textContent,
              Number(hargaClean), // Harga (Angka Bersih)
              cells[4].textContent,
              stokFisikValue,
              cells[6].textContent,
              Number(selisihRpText) // Selisih Rupiah (Angka Bersih)
          ];
          dataToExport.push(rowData);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Stock Opname");
      XLSX.writeFile(wb, filename);
    }

    // Download selisih
    function downloadSelisih(){
      const minus = window._minusItems || [];
      const plus = window._plusItems || [];
      const totalMinus = window._totalMinusRp || 0;
      const totalPlus = window._totalPlusRp || 0;

      const aoa = [];
      aoa.push(["=== ITEM MINUS ==="]);
      aoa.push(["No","PLU","Nama Barang","Stok Sistem","Stok Fisik","Selisih QTY","Selisih Rupiah"]);
      minus.forEach((r, i) => aoa.push([i+1, r.plu, r.nama, r.stokSistem, r.stokFisik, r.selisihQty, r.selisihRp]));
      aoa.push([]);
      aoa.push(["Total Rupiah Minus","","","","","", totalMinus]);
      aoa.push([]);
      aoa.push(["=== ITEM PLUS ==="]);
      aoa.push(["No","PLU","Nama Barang","Stok Sistem","Stok Fisik","Selisih QTY","Selisih Rupiah"]);
      plus.forEach((r, i) => aoa.push([i+1, r.plu, r.nama, r.stokSistem, r.stokFisik, r.selisihQty, r.selisihRp]));
      aoa.push([]);
      aoa.push(["TOTAL SELISIH RUPIAH","","","","","", totalMinus + totalPlus]);

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data Selisih");
      XLSX.writeFile(wb, "Data_Selisih.xlsx");
    }

    // helper: escape HTML to avoid XSS in table rendering
    function escapeHtml(str){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    // helper to escape JS string used in inline onblur attribute
    function escapeJs(s){
      return String(s).replace(/'/g,"\\'");
    }

    // --- FITUR MENCEGAH DATA HILANG ---
    const STORAGE_KEY = 'stockOpnameData';

    // Fungsi untuk menyimpan data ke Local Storage
    function saveToLocalStorage() {
      try {
        // Hapus selisihQty dan selisihRp agar tidak disimpan (akan dihitung ulang)
        const itemsToStore = allItems.map(({ selisihQty, selisihRp, ...rest }) => rest);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(itemsToStore));
      } catch (e) {
        console.error("Gagal menyimpan data ke Local Storage:", e);
      }
    }

    // Fungsi untuk memuat data dari Local Storage
    function loadFromLocalStorage() {
      try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
          // Hanya muat jika data yang tersimpan adalah array yang valid
          const parsedData = JSON.parse(storedData);
          if (Array.isArray(parsedData)) {
            allItems = parsedData;
          }
        }
      } catch (e) {
        console.error("Gagal memuat data dari Local Storage:", e);
      }
    }

    loadFromLocalStorage();

    window.addEventListener('beforeunload', function(e) {
      // Simpan data sebelum user meninggalkan halaman
      saveToLocalStorage(); 
      if (allItems.length > 0) {
        e.preventDefault();
        e.returnValue = 'Data Stok Opname Anda mungkin belum disimpan ke file. Apakah Anda yakin ingin meninggalkan halaman ini?';
      }
    });

    renderTable();
  </script>
</body>
</html>
