<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock Opname IDM T3EI</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:0; background:#ecf0f1; }
    .header-container { display:flex; justify-content:space-between; align-items:center;
                  padding:10px 20px; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .header-container img { height:40px; }
    .header-bg { display:flex; height:10px; }
    .color-red{flex:1;background:#e74c3c}.color-blue{flex:1;background:#3498db}.color-yellow{flex:1;background:#f1c40f}
    header h1 { text-align:center; font-size:2em; margin:20px 0; color:#333; }
    .container { width:90%; max-width:1200px; margin:20px auto; background:white; padding:20px;
                 border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,.1); }
    textarea { width:80%; height:120px; padding:10px; border:1px solid #ccc; border-radius:5px; }
    button { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; }
    .input-form button { background:#2ecc71; color:white; }
    .search-bar { text-align:center; margin:12px 0; }
    .search-bar input { width:70%; max-width:500px; padding:10px; border:1px solid #ddd;
                        border-radius:25px; text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f2f2f2; }
    .stok-fisik-cell input { width:120px; padding:5px; }
    .selisih-negatif{color:#e74c3c;font-weight:bold}.selisih-positif{color:#27ae60;font-weight:bold}
    .download-btn { background:#3498db; color:white; margin:10px 5px; }
    .section-title { text-align:center; font-size:1.5em; color:#555; margin:30px 0 10px; }
    .total-box { text-align:center; font-size:1.1em; font-weight:bold; padding:10px;
                 border:2px dashed #3498db; border-radius:8px; background:#e8f5ff; margin-top:10px; }
    .controls-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px; }
    .small { padding:8px 12px; font-size:0.95rem; }
    /* Menghilangkan elemen saat pencarian */
    .hidden { display: none; }
    nav { text-align: center; margin: 20px 0; }
    nav a { margin: 0 15px; text-decoration: none; color: #3498db; font-weight: bold; }
  </style>
</head>
<body>

  <nav>
    <a href="index.html">Menu Utama</a>
    <a href="halaman_lain.html" style="color: #f1c40f;">Program seles harian</a>
  </nav>

  <div class="header-container">
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Logo_Indomaret.png" alt="Logo Indomaret">
    <h1>STOCK OPNAME IDM T3EI</h1>
    <div></div>
  </div>
  <div class="header-bg"><div class="color-red"></div><div class="color-blue"></div><div class="color-yellow"></div></div>

  <div class="container">
    <h2 class="section-title">Input Data Stok Sistem (Multi-Baris)</h2>
    <div class="input-form">
      <textarea id="dataInput" placeholder="No| Nama Produk&#10;| PLU | Harga | Stok"></textarea><br>
      <div class="controls-row">
        <button class="small" onclick="addData()">Tambah Stok</button>
        <button class="small download-btn" style="background:#e74c3c;" onclick="resetStok()">Reset Stok Sistem</button>
        <button class="small download-btn" id="restoreButton" style="background:#f1c40f; display:none;" onclick="restoreData()">Pulihkan Data</button>
        <button class="small" onclick="fillExample()">Isi Contoh 5 Barang</button>
      </div>
    </div>

    <h2 class="section-title">Import Data Stok Sistem (XLSX)</h2>
    <div class="controls-row">
      <input type="file" id="fileInput" accept=".xlsx" />
    </div>

    <h2 class="section-title">Pencarian</h2>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Cari berdasarkan PLU atau Nama Barang... (ketik lalu tunggu)" />
    </div>

    <h2 class="section-title">Data Stok Fisik</h2>
    <table id="stokTable" role="table" aria-label="Tabel stok fisik">
      <thead>
        <tr>
          <th>No</th><th>PLU</th><th>Nama Barang</th><th>Harga</th><th>Stok Sistem</th>
          <th>Stok Fisik</th><th>Selisih QTY</th><th>Selisih Rupiah</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="text-align:center; margin-top:12px;">
      <button class="download-btn" onclick="downloadXLSX('stokTable','Semua_Data_Stock_Opname.xlsx')">Download Semua Data (XLSX)</button>
    </div>
  </div>

  <div class="container" id="selisihContainer" style="display:none;">
    <h2 class="section-title">Item Selisih</h2>

    <h3 style="margin-top:0">Item Minus</h3>
    <table id="selisihMinusTable">
      <thead><tr><th>No</th><th>PLU</th><th>Nama Barang</th><th>Stok Sistem</th><th>Stok Fisik</th><th>Selisih QTY</th><th>Selisih Rupiah</th></tr></thead>
      <tbody></tbody>
    </table>

    <h3 style="margin-top:18px">Item Plus</h3>
    <table id="selisihPlusTable">
      <thead><tr><th>No</th><th>PLU</th><th>Nama Barang</th><th>Stok Sistem</th><th>Stok Fisik</th><th>Selisih QTY</th><th>Selisih Rupiah</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="total-box" id="totalMinus">Total Rupiah Minus: Rp 0</div>
    <div class="total-box" id="totalPlus">Total Rupiah Plus: Rp 0</div>
    <div class="total-box" id="totalAll">Total Selisih Rupiah: Rp 0</div>

    <div style="text-align:center; margin-top:12px;">
      <button class="download-btn" onclick="downloadSelisih()">Download Data Selisih (XLSX)</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // data
    let allItems = [];
    let tempData = [];

    // DOM
    const tableBody = document.querySelector('#stokTable tbody');
    const selisihMinusBody = document.querySelector('#selisihMinusTable tbody');
    const selisihPlusBody = document.querySelector('#selisihPlusTable tbody');
    const selisihContainer = document.getElementById('selisihContainer');
    const totalMinusEl = document.getElementById('totalMinus');
    const totalPlusEl = document.getElementById('totalPlus');
    const totalAllEl = document.getElementById('totalAll');
    const searchInput = document.getElementById('searchInput');
    const restoreButton = document.getElementById('restoreButton');

    // Tambah data manual
    function addData(){
      const lines = document.getElementById('dataInput').value.split('\n').map(l=>l.trim()).filter(l=>l!=='');
      const newItems = [];
      let currentItem = {};
      
      lines.forEach(line => {
        const nameMatch = line.match(/^(\d+|)\s*\|\s*([^|]+)$/);
        if (nameMatch) {
          if (currentItem.nama) {
            newItems.push(currentItem);
          }
          currentItem = { nama: nameMatch[2].trim(), stokFisik: 0 };
          return;
        }

        const dataMatch = line.match(/\|\s*(\d+)\s*\|\s*([\d\.]+)\s*\|\s*STOK:\s*(\d+)$/);
        if (dataMatch) {
          if (currentItem.nama) {
            currentItem.plu = String(dataMatch[1]);
            currentItem.harga = Number(dataMatch[2].replace('.', ''));
            currentItem.stokSistem = Number(dataMatch[3]);
            newItems.push(currentItem);
            currentItem = {};
          }
        }
      });
      
      if (currentItem.nama) {
          newItems.push(currentItem);
      }

      if(newItems.length){
        allItems = allItems.concat(newItems);
        renderTable();
      }
      document.getElementById('dataInput').value = '';
    }

    // contoh isi (opsional)
    function fillExample(){
      const example = [
        "1001,Indomie Goreng,3500,100",
        "1002,Aqua 600ml,5000,50",
        "1003,Susu UHT,8000,30",
        "1004,Gula Pasir,12000,20",
        "1005,Teh Celup,2000,40"
      ].join('\n');
      document.getElementById('dataInput').value = example;
    }

    // reset -> hapus semua data stok sistem
    function resetStok(){
      tempData = JSON.parse(JSON.stringify(allItems));
      allItems = [];
      renderTable();
      selisihMinusBody.innerHTML = '';
      selisihPlusBody.innerHTML = '';
      selisihContainer.style.display = 'none';
      totalMinusEl.textContent = 'Total Rupiah Minus: Rp 0';
      totalPlusEl.textContent = 'Total Rupiah Plus: Rp 0';
      totalAllEl.textContent = 'Total Selisih Rupiah: Rp 0';
      const fileInput = document.getElementById('fileInput');
      if(fileInput) fileInput.value = '';
      saveToLocalStorage();
      if(tempData.length > 0) {
        restoreButton.style.display = 'block';
      }
    }

    // Fungsi untuk memulihkan data
    function restoreData(){
      allItems = JSON.parse(JSON.stringify(tempData));
      renderTable();
      restoreButton.style.display = 'none';
      saveToLocalStorage();
    }

    // render main table
    function renderTable(){
      tableBody.innerHTML = '';
      allItems.forEach((it, index)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${escapeHtml(String(it.plu))}</td>
          <td>${escapeHtml(String(it.nama))}</td>
          <td>${escapeHtml(String(it.harga))}</td>
          <td>${escapeHtml(String(it.stokSistem))}</td>
          <td class="stok-fisik-cell"><input type="text" inputmode="numeric" value="${it.stokFisik ? escapeHtml(String(it.stokFisik)) : ''}" onblur="updateFisik('${escapeJs(it.plu)}', this)"></td>
          <td class="selisih-qty"></td>
          <td class="selisih-rp"></td>
        `;
        tableBody.appendChild(tr);
      });
      updateAll();
      saveToLocalStorage();
    }

    // update stok fisik (mendukung input "2,2,3")
    function updateFisik(plu, inputEl){
      const pluKey = String(plu).trim();
      const item = allItems.find(i => String(i.plu).trim() === pluKey);
      if(!item) return;
      const parts = String(inputEl.value || '').split(',').map(v => parseInt(v.trim()) || 0);
      const total = parts.reduce((a,b)=>a+b, 0);
      item.stokFisik = total;
      inputEl.value = total;
      updateAll();
      saveToLocalStorage();
    }

    // update selisih, tabel minus/plus, totals, urutan & simpan array untuk export
    function updateAll(){
      selisihMinusBody.innerHTML = '';
      selisihPlusBody.innerHTML = '';
      let totalMinusRp = 0, totalPlusRp = 0;
      let anySelisih = false;
      const minusItems = [], plusItems = [];
      
      allItems.forEach(item => {
        const qty = (Number(item.stokFisik) || 0) - (Number(item.stokSistem) || 0);
        const rp = qty * (Number(item.harga) || 0);
        item.selisihQty = qty;
        item.selisihRp = rp;

        if (qty !== 0) {
          anySelisih = true;
          if (qty < 0) { minusItems.push(item); totalMinusRp += rp; }
          else { plusItems.push(item); totalPlusRp += rp; }
        }
      });
      
      [...tableBody.rows].forEach(tr => {
        const pluCell = tr.cells[1] && tr.cells[1].textContent ? tr.cells[1].textContent.trim() : '';
        const item = allItems.find(i => String(i.plu).trim() === pluCell);
        if (item) {
          const qcell = tr.querySelector('.selisih-qty');
          const rcell = tr.querySelector('.selisih-rp');
          qcell.textContent = item.selisihQty;
          rcell.textContent = item.selisihRp;
          qcell.className = 'selisih-qty';
          rcell.className = 'selisih-rp';
          if (item.selisihQty < 0) { qcell.classList.add('selisih-negatif'); rcell.classList.add('selisih-negatif'); }
          else if (item.selisihQty > 0) { qcell.classList.add('selisih-positif'); rcell.classList.add('selisih-positif'); }
        }
      });

      minusItems.sort((a,b) => Math.abs(b.selisihRp) - Math.abs(a.selisihRp));
      plusItems.sort((a,b) => Math.abs(b.selisihRp) - Math.abs(a.selisihRp));
      
      minusItems.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(r.plu)}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.stokSistem)}</td><td>${escapeHtml(r.stokFisik)}</td><td>${escapeHtml(r.selisihQty)}</td><td>${escapeHtml(r.selisihRp)}</td>`;
        selisihMinusBody.appendChild(row);
      });
      plusItems.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(r.plu)}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.stokSistem)}</td><td>${escapeHtml(r.stokFisik)}</td><td>${escapeHtml(r.selisihQty)}</td><td>${escapeHtml(r.selisihRp)}</td>`;
        selisihPlusBody.appendChild(row);
      });

      selisihContainer.style.display = anySelisih ? 'block' : 'none';
      totalMinusEl.textContent = 'Total Rupiah Minus: Rp ' + totalMinusRp.toLocaleString('id-ID');
      totalPlusEl.textContent  = 'Total Rupiah Plus: Rp ' + totalPlusRp.toLocaleString('id-ID');
      totalAllEl.textContent   = 'Total Selisih Rupiah: Rp ' + (totalMinusRp + totalPlusRp).toLocaleString('id-ID');

      window._minusItems = minusItems;
      window._plusItems = plusItems;
      window._totalMinusRp = totalMinusRp;
      window._totalPlusRp = totalPlusRp;
    }

    // Pencarian: menyembunyikan/menampilkan baris
    function performSearch(){
      const q = (searchInput.value || '').toString().trim().toLowerCase();
      const rows = document.querySelectorAll('#stokTable tbody tr');
      let visibleCount = 0;
      rows.forEach(tr => {
        const plu = tr.cells[1].textContent.trim().toLowerCase();
        const name = tr.cells[2].textContent.trim().toLowerCase();
        const isMatch = plu.includes(q) || name.includes(q);
        tr.style.display = isMatch ? '' : 'none';
        
        if (isMatch) {
            tr.cells[0].textContent = ++visibleCount;
        }
      });
    }

    // attach search listener (debounce kecil)
    let _searchTimer = null;
    searchInput.addEventListener('input', function(){
      if(_searchTimer) clearTimeout(_searchTimer);
      _searchTimer = setTimeout(() => { performSearch(); _searchTimer = null; }, 150);
    });
    
    // Import dari XLSX
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    function handleFile(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        const newItems = [];
        rows.slice(1).forEach(r=>{
          if(r && r.length >= 4){
            newItems.push({
              plu: String(r[0]),
              nama: String(r[1]),
              harga: Number(r[2]) || 0,
              stokSistem: Number(r[3]) || 0,
              stokFisik: Number(r[4]) || 0
            });
          }
        });
        allItems = newItems;
        renderTable();
      };
      reader.readAsArrayBuffer(file);
    }

    // Download semua data
    function downloadXLSX(tableId, filename){
      const table = document.getElementById(tableId);
      const rowsToExport = [...table.querySelectorAll('tbody tr')].filter(tr => tr.style.display !== 'none');
      const dataToExport = [['No', 'PLU', 'Nama Barang', 'Harga', 'Stok Sistem', 'Stok Fisik', 'Selisih QTY', 'Selisih Rupiah']];
      
      rowsToExport.forEach(row => {
          const cells = [...row.cells];
          const rowData = [
              cells[0].textContent,
              cells[1].textContent,
              cells[2].textContent,
              cells[3].textContent,
              cells[4].textContent,
              cells[5].querySelector('input') ? cells[5].querySelector('input').value : cells[5].textContent,
              cells[6].textContent,
              cells[7].textContent
          ];
          dataToExport.push(rowData);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Stock Opname");
      XLSX.writeFile(wb, filename);
    }

    // Download selisih
    function downloadSelisih(){
      const minus = window._minusItems || [];
      const plus = window._plusItems || [];
      const totalMinus = window._totalMinusRp || 0;
      const totalPlus = window._totalPlusRp || 0;

      const aoa = [];
      aoa.push(["=== ITEM MINUS ==="]);
      aoa.push(["No","PLU","Nama Barang","Stok Sistem","Stok Fisik","Selisih QTY","Selisih Rupiah"]);
      minus.forEach((r, i) => aoa.push([i+1, r.plu, r.nama, r.stokSistem, r.stokFisik, r.selisihQty, r.selisihRp]));
      aoa.push([]);
      aoa.push(["Total Rupiah Minus","","","","","", totalMinus]);
      aoa.push([]);
      aoa.push(["=== ITEM PLUS ==="]);
      aoa.push(["No","PLU","Nama Barang","Stok Sistem","Stok Fisik","Selisih QTY","Selisih Rupiah"]);
      plus.forEach((r, i) => aoa.push([i+1, r.plu, r.nama, r.stokSistem, r.stokFisik, r.selisihQty, r.selisihRp]));
      aoa.push([]);
      aoa.push(["Total Rupiah Plus","","","","","", totalPlus]);
      aoa.push([]);
      aoa.push(["TOTAL SELISIH RUPIAH","","","","","", totalMinus + totalPlus]);

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data Selisih");
      XLSX.writeFile(wb, "Data_Selisih.xlsx");
    }

    // helper: escape HTML to avoid XSS in table rendering
    function escapeHtml(str){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    // helper to escape JS string used in inline onblur attribute
    function escapeJs(s){
      return String(s).replace(/'/g,"\\'");
    }

    // --- FITUR BARU: MENCEGAH DATA HILANG ---
    const STORAGE_KEY = 'stockOpnameData';

    // Fungsi untuk menyimpan data ke Local Storage
    function saveToLocalStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(allItems));
      } catch (e) {
        console.error("Gagal menyimpan data ke Local Storage:", e);
      }
    }

    // Fungsi untuk memuat data dari Local Storage
    function loadFromLocalStorage() {
      try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
          allItems = JSON.parse(storedData);
        }
      } catch (e) {
        console.error("Gagal memuat data dari Local Storage:", e);
      }
    }

    loadFromLocalStorage();

    window.addEventListener('beforeunload', function(e) {
      if (allItems.length > 0) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    renderTable();
  </script>
</body>
</html>
