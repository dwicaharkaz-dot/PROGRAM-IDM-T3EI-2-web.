    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // data
    let allItems = [];
    let tempData = []; // Variabel sementara untuk menyimpan data sebelum reset

    // DOM
    const tableBody = document.querySelector('#stokTable tbody');
    const selisihMinusBody = document.querySelector('#selisihMinusTable tbody');
    const selisihPlusBody = document.querySelector('#selisihPlusTable tbody');
    const selisihContainer = document.getElementById('selisihContainer');
    const totalMinusEl = document.getElementById('totalMinus');
    const totalPlusEl = document.getElementById('totalPlus');
    const totalAllEl = document.getElementById('totalAll');
    const searchInput = document.getElementById('searchInput');
    const restoreButton = document.getElementById('restoreButton');

    // Tambah data manual
    function addData(){
      const lines = document.getElementById('dataInput').value.split('\n').map(l=>l.trim()).filter(l=>l!=='');
      const newItems = [];
      let currentItem = {};
      
      lines.forEach(line => {
        // Cek baris nama produk
        const nameMatch = line.match(/^(\d+|)\s*\|\s*([^|]+)$/);
        if (nameMatch) {
          if (currentItem.nama) { // Jika ada item sebelumnya, simpan
            newItems.push(currentItem);
          }
          currentItem = { nama: nameMatch[2].trim(), stokFisik: 0 };
          return;
        }

        // Cek baris PLU, Harga, Stok
        const dataMatch = line.match(/\|\s*(\d+)\s*\|\s*([\d\.]+)\s*\|\s*STOK:\s*(\d+)$/);
        if (dataMatch) {
          if (currentItem.nama) { // Memastikan ada nama produk sebelumnya
            currentItem.plu = String(dataMatch[1]);
            currentItem.harga = Number(dataMatch[2].replace('.', ''));
            currentItem.stokSistem = Number(dataMatch[3]);
            newItems.push(currentItem);
            currentItem = {}; // Reset untuk item berikutnya
          }
        }
      });
      
      // Simpan item terakhir jika belum tersimpan
      if (currentItem.nama) {
          newItems.push(currentItem);
      }

      if(newItems.length){
        allItems = allItems.concat(newItems);
        renderTable();
      }
      document.getElementById('dataInput').value = '';
    }

    // contoh isi (opsional)
    function fillExample(){
      const example = [
        "01| Indomie Goreng",
        "  | 1001 | 3.500 | STOK: 100",
        "______________________________",
        "02| Aqua 600ml",
        "  | 1002 | 5.000 | STOK: 50",
        "______________________________",
        "03| Susu UHT",
        "  | 1003 | 8.000 | STOK: 30"
      ].join('\n');
      document.getElementById('dataInput').value = example;
    }

    // reset -> hapus semua data stok sistem
    function resetStok(){
      // Simpan data saat ini ke variabel sementara
      tempData = JSON.parse(JSON.stringify(allItems));
      allItems = [];
      renderTable();
      selisihMinusBody.innerHTML = '';
      selisihPlusBody.innerHTML = '';
      selisihContainer.style.display = 'none';
      totalMinusEl.textContent = 'Total Rupiah Minus: Rp 0';
      totalPlusEl.textContent = 'Total Rupiah Plus: Rp 0';
      totalAllEl.textContent = 'Total Selisih Rupiah: Rp 0';
      const fileInput = document.getElementById('fileInput');
      if(fileInput) fileInput.value = '';
      saveToLocalStorage();
      // Tampilkan tombol pulihkan
      if(tempData.length > 0) {
        restoreButton.style.display = 'block';
      }
    }

    // Fungsi untuk memulihkan data
    function restoreData(){
      allItems = JSON.parse(JSON.stringify(tempData));
      renderTable();
      restoreButton.style.display = 'none'; // Sembunyikan tombol setelah pemulihan
      saveToLocalStorage();
    }

    // render main table
    function renderTable(){
      tableBody.innerHTML = '';
      allItems.forEach((it, index)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${escapeHtml(String(it.plu))}</td>
          <td>${escapeHtml(String(it.nama))}</td>
          <td>${escapeHtml(String(it.harga))}</td>
          <td>${escapeHtml(String(it.stokSistem))}</td>
          <td class="stok-fisik-cell"><input type="text" inputmode="numeric" value="${it.stokFisik ? escapeHtml(String(it.stokFisik)) : ''}" onblur="updateFisik('${escapeJs(it.plu)}', this)"></td>
          <td class="selisih-qty"></td>
          <td class="selisih-rp"></td>
        `;
        tableBody.appendChild(tr);
      });
      updateAll();
      saveToLocalStorage();
    }

    // update stok fisik (mendukung input "2,2,3")
    function updateFisik(plu, inputEl){
      const pluKey = String(plu).trim();
      const item = allItems.find(i => String(i.plu).trim() === pluKey);
      if(!item) return;
      const parts = String(inputEl.value || '').split(',').map(v => parseInt(v.trim()) || 0);
      const total = parts.reduce((a,b)=>a+b, 0);
      item.stokFisik = total;
      inputEl.value = total;
      updateAll();
      saveToLocalStorage();
    }

    // update selisih, tabel minus/plus, totals, urutan & simpan array untuk export
    function updateAll(){
      selisihMinusBody.innerHTML = '';
      selisihPlusBody.innerHTML = '';
      let totalMinusRp = 0, totalPlusRp = 0;
      let anySelisih = false;
      const minusItems = [], plusItems = [];
      
      allItems.forEach(item => {
        const qty = (Number(item.stokFisik) || 0) - (Number(item.stokSistem) || 0);
        const rp = qty * (Number(item.harga) || 0);
        item.selisihQty = qty;
        item.selisihRp = rp;

        if (qty !== 0) {
          anySelisih = true;
          if (qty < 0) { minusItems.push(item); totalMinusRp += rp; }
          else { plusItems.push(item); totalPlusRp += rp; }
        }
      });
      
      [...tableBody.rows].forEach(tr => {
        const pluCell = tr.cells[1] && tr.cells[1].textContent ? tr.cells[1].textContent.trim() : '';
        const item = allItems.find(i => String(i.plu).trim() === pluCell);
        if (item) {
          const qcell = tr.querySelector('.selisih-qty');
          const rcell = tr.querySelector('.selisih-rp');
          qcell.textContent = item.selisihQty;
          rcell.textContent = item.selisihRp;
          qcell.className = 'selisih-qty';
          rcell.className = 'selisih-rp';
          if (item.selisihQty < 0) { qcell.classList.add('selisih-negatif'); rcell.classList.add('selisih-negatif'); }
          else if (item.selisihQty > 0) { qcell.classList.add('selisih-positif'); rcell.classList.add('selisih-positif'); }
        }
      });

      minusItems.sort((a,b) => Math.abs(b.selisihRp) - Math.abs(a.selisihRp));
      plusItems.sort((a,b) => Math.abs(b.selisihRp) - Math.abs(a.selisihRp));
      
      minusItems.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(r.plu)}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.stokSistem)}</td><td>${escapeHtml(r.stokFisik)}</td><td>${escapeHtml(r.selisihQty)}</td><td>${escapeHtml(r.selisihRp)}</td>`;
        selisihMinusBody.appendChild(row);
      });
      plusItems.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(r.plu)}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.stokSistem)}</td><td>${escapeHtml(r.stokFisik)}</td><td>${escapeHtml(r.selisihQty)}</td><td>${escapeHtml(r.selisihRp)}</td>`;
        selisihPlusBody.appendChild(row);
      });

      selisihContainer.style.display = anySelisih ? 'block' : 'none';
      totalMinusEl.textContent = 'Total Rupiah Minus: Rp ' + totalMinusRp.toLocaleString('id-ID');
      totalPlusEl.textContent  = 'Total Rupiah Plus: Rp ' + totalPlusRp.toLocaleString('id-ID');
      totalAllEl.textContent   = 'Total Selisih Rupiah: Rp ' + (totalMinusRp + totalPlusRp).toLocaleString('id-ID');

      window._minusItems = minusItems;
      window._plusItems = plusItems;
      window._totalMinusRp = totalMinusRp;
      window._totalPlusRp = totalPlusRp;
    }

    // Pencarian: menyembunyikan/menampilkan baris
    function performSearch(){
      const q = (searchInput.value || '').toString().trim().toLowerCase();
      const rows = document.querySelectorAll('#stokTable tbody tr');
      let visibleCount = 0;
      rows.forEach(tr => {
        const plu = tr.cells[1].textContent.trim().toLowerCase();
        const name = tr.cells[2].textContent.trim().toLowerCase();
        const isMatch = plu.includes(q) || name.includes(q);
        tr.style.display = isMatch ? '' : 'none';
        
        if (isMatch) {
            tr.cells[0].textContent = ++visibleCount;
        }
      });
    }

    // attach search listener (debounce kecil)
    let _searchTimer = null;
    searchInput.addEventListener('input', function(){
      if(_searchTimer) clearTimeout(_searchTimer);
      _searchTimer = setTimeout(() => { performSearch(); _searchTimer = null; }, 150);
    });
    
    // Import dari XLSX
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    function handleFile(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        const newItems = [];
        rows.slice(1).forEach(r=>{
          if(r && r.length >= 4){
            newItems.push({
              plu: String(r[0]),
              nama: String(r[1]),
              harga: Number(r[2]) || 0,
              stokSistem: Number(r[3]) || 0,
              stokFisik: Number(r[4]) || 0
            });
          }
        });
        allItems = newItems;
        renderTable();
      };
      reader.readAsArrayBuffer(file);
    }

    // Download semua data
    function downloadXLSX(tableId, filename){
      const table = document.getElementById(tableId);
      const rowsToExport = [...table.querySelectorAll('tbody tr')].filter(tr => tr.style.display !== 'none');
      const dataToExport = [['No', 'PLU', 'Nama Barang', 'Harga', 'Stok Sistem', 'Stok Fisik', 'Selisih QTY', 'Selisih Rupiah']];
      
      rowsToExport.forEach(row => {
          const cells = [...row.cells];
          const rowData = [
              cells[0].textContent,
              cells[1].textContent,
              cells[2].textContent,
              cells[3].textContent,
              cells[4].textContent,
              cells[5].querySelector('input') ? cells[5].querySelector('input').value : cells[5].textContent,
              cells[6].textContent,
              cells[7].textContent
          ];
          dataToExport.push(rowData);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Stock Opname");
      XLSX.writeFile(wb, filename);
    }

    // Download selisih
    function downloadSelisih(){
      const minus = window._minusItems || [];
      const plus = window._plusItems || [];
      const totalMinus = window._totalMinusRp || 0;
      const totalPlus = window._totalPlusRp || 0;

      const aoa = [];
      aoa.push(["=== ITEM MINUS ==="]);
      aoa.push(["No","PLU","Nama Barang","Stok Sistem","Stok Fisik","Selisih QTY","Selisih Rupiah"]);
      minus.forEach((r, i) => aoa.push([i+1, r.plu, r.nama, r.stokSistem, r.stokFisik, r.selisihQty, r.selisihRp]));
      aoa.push([]);
      aoa.push(["Total Rupiah Minus","","","","","", totalMinus]);
      aoa.push([]);
      aoa.push(["=== ITEM PLUS ==="]);
      aoa.push(["No","PLU","Nama Barang","Stok Sistem","Stok Fisik","Selisih QTY","Selisih Rupiah"]);
      plus.forEach((r, i) => aoa.push([i+1, r.plu, r.nama, r.stokSistem, r.stokFisik, r.selisihQty, r.selisihRp]));
      aoa.push([]);
      aoa.push(["Total Rupiah Plus","","","","","", totalPlus]);
      aoa.push([]);
      aoa.push(["TOTAL SELISIH RUPIAH","","","","","", totalMinus + totalPlus]);

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data Selisih");
      XLSX.writeFile(wb, "Data_Selisih.xlsx");
    }

    // helper: escape HTML to avoid XSS in table rendering
    function escapeHtml(str){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    // helper to escape JS string used in inline onblur attribute
    function escapeJs(s){
      return String(s).replace(/'/g,"\\'");
    }

    // --- FITUR BARU: MENCEGAH DATA HILANG ---
    const STORAGE_KEY = 'stockOpnameData';

    // Fungsi untuk menyimpan data ke Local Storage
    function saveToLocalStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(allItems));
      } catch (e) {
        console.error("Gagal menyimpan data ke Local Storage:", e);
      }
    }

    // Fungsi untuk memuat data dari Local Storage
    function loadFromLocalStorage() {
      try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
          allItems = JSON.parse(storedData);
        }
      } catch (e) {
        console.error("Gagal memuat data dari Local Storage:", e);
      }
    }

    // Memuat data saat halaman pertama kali dibuka
    loadFromLocalStorage();

    // Event listener untuk memunculkan peringatan saat akan menutup tab
    window.addEventListener('beforeunload', function(e) {
      if (allItems.length > 0) {
        e.preventDefault();
        e.returnValue = ''; // Diperlukan untuk kompatibilitas di beberapa browser
      }
    });

    // Initial render
    renderTable();
  </script>
</body>
</html>
